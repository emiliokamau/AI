<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Assistant</title>
    <script src="/static/api-config.js"></script>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Google Maps API - Replace YOUR_API_KEY with actual Google Maps API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&libraries=places" defer></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #0d6efd, #0056b3);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: none;
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }
        
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .task-option {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .task-option:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
        }
        
        .task-option.selected {
            background-color: rgba(13, 110, 253, 0.1);
            border-color: var(--primary-color);
        }
        
        .task-option i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-right: 10px;
        }
        
        .chat-container {
            display: none;
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #0d6efd, #0056b3);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            height: calc(100% - 120px);
            overflow-y: auto;
            padding: 20px;
            background-color: white;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.ai .message-content {
            background-color: #f1f3f5;
            color: #333;
            border-top-left-radius: 0;
        }
        
        .message.user .message-content {
            background-color: var(--primary-color);
            color: white;
            border-top-right-radius: 0;
        }
        
        /* Thinking mode styles */
        .thinking-message .message-content {
            background: linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%);
            border: 1px solid #b3d9ff;
        }
        
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0d6efd;
            font-weight: 500;
            margin-bottom: 8px;
            animation: thinking-pulse 2s ease-in-out infinite;
        }
        
        .thinking-indicator i {
            animation: thinking-spin 2s linear infinite;
        }
        
        .streaming-content {
            line-height: 1.5;
        }
        
        @keyframes thinking-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes thinking-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            background-color: white;
            display: flex;
        }
        
        .chat-input {
            flex-grow: 1;
            border: 1px solid #ced4da;
            border-radius: 20px;
            padding: 8px 15px;
            margin-right: 10px;
        }
        
        .emergency-alert {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            border: 1px solid #f5c6cb;
        }
        
        .emergency-alert i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 10px;
        }
        
        .loading-indicator i {
            animation: spin 1.5s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .footer {
            background-color: #f8f9fa;
            padding: 2rem 0;
            margin-top: 3rem;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
        }
        
        /* Modern Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 80px;
            bottom: 0;
            width: 260px;
            background: #ffffff;
            border-right: 1px solid #e0e0e0;
            padding: 0;
            overflow-y: auto;
            z-index: 1050;
            box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            transition: width .3s ease, transform .22s ease;
        }
        
        .sidebar.collapsed {
            width: 70px;
        }
        
        .sidebar-collapse-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: #f8f9fa;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s ease;
            width: 100%;
        }
        
        .sidebar-collapse-btn:hover {
            background: #e9ecef;
        }
        
        .sidebar-collapse-btn i {
            font-size: 20px;
            color: #495057;
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed .sidebar-collapse-btn i {
            transform: rotate(180deg);
        }
        
        .sidebar-section {
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .sidebar-section-header:hover {
            background: #f8f9fa;
        }
        
        .sidebar-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
            letter-spacing: 0.5px;
            flex: 1;
        }
        
        .sidebar-section-toggle {
            font-size: 14px;
            color: #6c757d;
            transition: transform 0.3s ease;
        }
        
        .sidebar-section.collapsed .sidebar-section-toggle {
            transform: rotate(-90deg);
        }
        
        .sidebar-section-content {
            padding: 0 16px 16px 16px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .sidebar-section.collapsed .sidebar-section-content {
            max-height: 0;
            padding: 0 16px;
        }
        
        .sidebar.collapsed .sidebar-section-header {
            justify-content: center;
        }
        
        .sidebar.collapsed .sidebar-section-title,
        .sidebar.collapsed .sidebar-section-toggle {
            display: none;
        }
        
        .sidebar-nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            color: #495057;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
        }
        
        .sidebar-nav-item:hover {
            background: #f8f9fa;
            color: #0d6efd;
        }
        
        .sidebar-nav-item.active {
            background: #e7f1ff;
            color: #0d6efd;
        }
        
        .sidebar-nav-item i {
            font-size: 18px;
            width: 24px;
            margin-right: 12px;
            min-width: 24px;
        }
        
        .sidebar.collapsed .sidebar-nav-item {
            justify-content: center;
            padding: 12px 8px;
        }
        
        .sidebar.collapsed .sidebar-nav-item span {
            display: none;
        }
        
        .sidebar.collapsed .sidebar-nav-item i {
            margin-right: 0;
        }
        
        /* Tooltip for collapsed sidebar */
        .sidebar.collapsed .sidebar-nav-item:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 10000;
            pointer-events: none;
        }
        
        .sidebar-actions {
            padding: 16px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sidebar.collapsed .sidebar-actions {
            flex-direction: column;
            padding: 8px;
        }
        
        .sidebar.collapsed .sidebar-actions button {
            width: 100% !important;
            padding: 8px 4px;
            font-size: 11px;
        }
        
        #mainContent { 
            transition: margin-left .3s ease; 
            margin-left: 260px; 
        }
        
        #mainContent.collapsed { 
            margin-left: 70px; 
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            #mainContent { margin-left: 260px; }
        }
        @media (max-width: 768px) {
            /* Sidebar behaves as overlay on small screens */
            #sidebar { transform: translateX(-100%); width: 260px !important; }
            #sidebar.show { transform: translateX(0); }
            #mainContent { margin-left: 0 !important; }
            .chat-input-container { flex-wrap: wrap; gap: 8px; }
            .chat-input { flex: 1 1 100%; margin-right: 0; }
            #uploadBtn, #sendBtn, #emergencyBtn { width: 100%; }
        }

        /* Health Dashboard Styles */
        .health-dashboard {
            display: none;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .risk-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .risk-badge.low {
            background-color: #d4edda;
            color: #155724;
        }

        .risk-badge.medium {
            background-color: #fff3cd;
            color: #856404;
        }

        .risk-badge.high {
            background-color: #f8d7da;
            color: #721c24;
        }

        .metric-chart {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .risk-progress {
            margin: 15px 0;
        }

        .risk-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .metric-form-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .metric-form-group h6 {
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }

        .dm-container {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background: #fff;
            padding: 12px;
        }

        .dm-messages {
            height: 280px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .dm-message {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
        }

        .dm-message.me {
            margin-left: auto;
            background: rgba(13,110,253,0.1);
            border: 1px solid rgba(13,110,253,0.2);
        }

        .dm-meta {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .notification-list {
            max-height: 220px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="/static/logo.svg" alt="Medical AI Logo" style="width: 48px; height: 48px; object-fit: contain;">
                <h1 class="h3 mb-0">Medical AI Assistant</h1>
            </div>
            <p class="mb-0 mt-2">Your virtual health companion for guidance and support</p>
            <div class="mt-2 text-white">Welcome, <span id="patientWelcomeName">Patient</span></div>
        </div>
    </header>

    <!-- Fixed toggle button above sidebar (stays visible) -->
    <button id="fixedToggleBtn" class="btn btn-outline-secondary" title="Toggle sidebar" style="position:fixed;left:12px;top:92px;z-index:1100;padding:6px 8px;"><i class="bi bi-list"></i></button>

    <!-- Sidebar overlay for small screens -->
    <div id="sidebarOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:1049;display:none;"></div>

    <!-- Sidebar with navigation and session history -->
    <div id="sidebar" class="sidebar">
        <!-- Collapse Button -->
        <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Collapse sidebar">
            <i class="bi bi-chevron-left"></i>
        </button>
        
        <!-- Main Navigation -->
        <div class="sidebar-section" data-section="main">
            <div class="sidebar-section-header">
                <div class="sidebar-section-title">Main</div>
                <i class="bi bi-chevron-down sidebar-section-toggle"></i>
            </div>
            <div class="sidebar-section-content">
                <button class="sidebar-nav-item" id="homeBtn" data-tooltip="Home">
                    <i class="bi bi-house"></i>
                    <span>Home</span>
                </button>
                <button class="sidebar-nav-item" id="newChatBtn" data-tooltip="New Chat">
                    <i class="bi bi-chat-dots"></i>
                    <span>New Chat</span>
                </button>
                <button class="sidebar-nav-item" id="profileBtn" data-tooltip="My Profile">
                    <i class="bi bi-person-circle"></i>
                    <span>My Profile</span>
                </button>
            </div>
        </div>
        
        <!-- Health Management -->
        <div class="sidebar-section" data-section="health">
            <div class="sidebar-section-header">
                <div class="sidebar-section-title">Health Management</div>
                <i class="bi bi-chevron-down sidebar-section-toggle"></i>
            </div>
            <div class="sidebar-section-content">
                <button class="sidebar-nav-item" id="healthDashboardBtn" data-tooltip="Health Dashboard">
                    <i class="bi bi-graph-up"></i>
                    <span>Health Dashboard</span>
                </button>
                <button class="sidebar-nav-item" id="logMetricBtn" data-tooltip="Log Health Metric">
                    <i class="bi bi-plus-circle"></i>
                    <span>Log Health Metric</span>
                </button>
                <button class="sidebar-nav-item" id="riskAssessmentBtn" data-tooltip="Risk Assessment">
                    <i class="bi bi-exclamation-circle"></i>
                    <span>Risk Assessment</span>
                </button>
                <button class="sidebar-nav-item" id="medicationsBtn" data-tooltip="Medications & Reminders">
                    <i class="bi bi-capsule"></i>
                    <span>Medications</span>
                </button>
                <button class="sidebar-nav-item" id="adherenceBtn" data-tooltip="Medication Adherence">
                    <i class="bi bi-check2-circle"></i>
                    <span>Adherence</span>
                </button>
                <button class="sidebar-nav-item" id="documentsBtn" data-tooltip="Medical Documents">
                    <i class="bi bi-file-earmark-medical"></i>
                    <span>Documents</span>
                </button>
            </div>
        </div>
        
        <!-- Communication -->
        <div class="sidebar-section" data-section="communication">
            <div class="sidebar-section-header">
                <div class="sidebar-section-title">Communication</div>
                <i class="bi bi-chevron-down sidebar-section-toggle"></i>
            </div>
            <div class="sidebar-section-content">
                <button class="sidebar-nav-item" id="messagesBtn" data-tooltip="Messages">
                    <i class="bi bi-chat-left-text"></i>
                    <span>Messages</span>
                </button>
                <button class="sidebar-nav-item" id="notificationsBtn" data-tooltip="Notifications">
                    <i class="bi bi-bell"></i>
                    <span>Notifications</span>
                </button>
                <button class="sidebar-nav-item" id="forumBtn" data-tooltip="Community Forum">
                    <i class="bi bi-people"></i>
                    <span>Community Forum</span>
                </button>
                <button class="sidebar-nav-item" id="nearbyHospitalsBtn" data-tooltip="Nearby Hospitals">
                    <i class="bi bi-hospital"></i>
                    <span>Nearby Hospitals</span>
                </button>
            </div>
        </div>
        
        <!-- Healthcare Services -->
        <div class="sidebar-section" data-section="healthcare">
            <div class="sidebar-section-header">
                <div class="sidebar-section-title">Healthcare Services</div>
                <i class="bi bi-chevron-down sidebar-section-toggle"></i>
            </div>
            <div class="sidebar-section-content">
                <button class="sidebar-nav-item" id="aiDoctorMatchingBtn" data-tooltip="AI Doctor Matching">
                    <i class="bi bi-brain"></i>
                    <span>AI Doctor Matching</span>
                </button>
                <button class="sidebar-nav-item" id="videoConsultationBtn" data-tooltip="Video Consultation">
                    <i class="bi bi-camera-video"></i>
                    <span>Video Consultation</span>
                </button>
                <button class="sidebar-nav-item" id="appointmentBtn" data-tooltip="Book Appointment">
                    <i class="bi bi-calendar2-check"></i>
                    <span>Book Appointment</span>
                </button>
            </div>
        </div>
        
        <!-- Account Actions -->
        <div class="sidebar-actions">
            <button class="btn btn-sm btn-success w-50" id="loginBtn">Login</button>
            <button class="btn btn-sm btn-outline-danger w-50" id="logoutBtn">Logout</button>
        </div>
        
        <!-- Conversations History -->
        <div class="sidebar-section" data-section="conversations">
            <div class="sidebar-section-header">
                <div class="sidebar-section-title">Conversations</div>
                <i class="bi bi-chevron-down sidebar-section-toggle"></i>
            </div>
            <div class="sidebar-section-content">
                <div id="sessionsList" style="padding: 0 8px;"></div>
            </div>
        </div>
    </div>

    <main id="mainContent" class="container my-5">
        <div class="emergency-alert" id="emergencyAlert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>Emergency Notice:</strong> If you're experiencing a medical emergency, please call emergency services immediately or go to the nearest emergency room.
        </div>

        <!-- AI Doctor Matching Content Section -->
        <div id="aiDoctorMatchingSection" style="display:none;">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-brain me-2"></i>AI-Powered Doctor Matching
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                <i class="bi bi-info-circle"></i> Describe your symptoms and let our AI find the best doctor for you based on your location
                            </p>
                            <div class="mb-3">
                                <label class="form-label">Describe Your Symptoms</label>
                                <textarea id="symptomInput" 
                                          class="form-control" 
                                          rows="4"
                                          placeholder="Example: I have severe chest pain when running, shortness of breath, and dizziness. Started 3 days ago."></textarea>
                            </div>
                            <div class="mb-3">
                                <button id="getRecommendationBtn" class="btn btn-info w-100">
                                    <i class="bi bi-magic"></i> Find Best Doctor for Me
                                </button>
                                <small class="text-muted d-block mt-2">
                                    <i class="bi bi-geo-alt"></i> This will request access to your location
                                </small>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="recommendationLoading" class="text-center" style="display:none;">
                                <div class="spinner-border spinner-border-sm text-info me-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="text-muted">Finding doctors matching your symptoms...</span>
                            </div>
                            
                            <!-- Recommendations Results -->
                            <div id="doctorRecommendations" class="mt-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Video Consultation Content Section -->
        <div id="videoConsultationSection" style="display:none;">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-camera-video me-2"></i>Schedule a Video Consultation
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                <i class="bi bi-info-circle"></i> Get immediate help through Google Meet video call without traveling
                            </p>
                            
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Select Doctor</label>
                                    <select id="videoConsultationDoctor" class="form-select">
                                        <option value="">-- Select a Doctor --</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Preferred Date</label>
                                    <input id="videoConsultationDate" type="date" class="form-control" />
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label class="form-label">Available Time Slots</label>
                                <div id="videoSlots" class="d-flex flex-wrap gap-2 mb-3">
                                    <p class="text-muted small">Select a doctor and date to view available slots</p>
                                </div>
                            </div>
                            
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Reason for Consultation</label>
                                    <input id="videoConsultationReason" class="form-control" 
                                           placeholder="Brief description of your concern" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Duration</label>
                                    <select id="videoConsultationDuration" class="form-select">
                                        <option value="30">30 minutes</option>
                                        <option value="45">45 minutes</option>
                                        <option value="60">1 hour</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button id="scheduleVideoBtn" class="btn btn-info w-100">
                                    <i class="bi bi-camera-video"></i> Schedule Video Consultation
                                </button>
                            </div>
                            <div id="videoResult" class="mt-2"></div>
                            
                            <!-- Google Meet Link Display -->
                            <div id="videoMeetLinkSection" class="alert alert-success mt-3" style="display:none;">
                                <h6>Video Consultation Scheduled!</h6>
                                <p class="mb-2">
                                    <i class="bi bi-clock-history me-2"></i>
                                    <span id="videoConsultationTime"></span>
                                </p>
                                <p class="mb-3">
                                    <a id="googleMeetLink" href="#" target="_blank" class="btn btn-primary btn-sm">
                                        <i class="bi bi-camera-video"></i> Join Google Meet
                                    </a>
                                </p>
                                <small class="text-muted">You'll receive a notification before the call starts.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Book Appointment Content Section -->
        <div id="appointmentSection" style="display:none;">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-calendar2-check me-2"></i>Book an Appointment
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Hospital</label>
                                    <select id="appointmentHospital" class="form-select"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Doctor (optional)</label>
                                    <select id="appointmentDoctor" class="form-select"></select>
                                </div>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Preferred Date/Time</label>
                                    <input id="appointmentTime" type="datetime-local" class="form-control" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Reason</label>
                                    <input id="appointmentReason" class="form-control" placeholder="Reason for visit" />
                                </div>
                            </div>
                            <div class="mt-3 d-flex gap-2">
                                <button id="bookAppointmentBtn" class="btn btn-primary">Book Appointment</button>
                                <button id="refreshAppointmentsBtn" class="btn btn-outline-secondary">Refresh</button>
                            </div>
                            <div id="appointmentResult" class="mt-2"></div>
                            <div id="appointmentList" class="mt-3">
                                <p class="text-muted">No appointments loaded.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="patientForm">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clipboard-check me-2"></i>Help Category
                    </div>
                    <div class="card-body">
                        <label for="helpCategory" class="form-label">Choose a help category</label>
                        <select id="helpCategory" class="form-select mb-2">
                            <option value="">-- Select category --</option>
                            <option value="symptoms">Symptom Checker</option>
                            <option value="medication">Medication Information</option>
                            <option value="health-education">Health Education</option>
                            <option value="lifestyle">Lifestyle Advice</option>
                            <option value="mental-health">Mental Health Support</option>
                            <option value="other">Other</option>
                            <option value="emergency">Emergency Chat</option>
                        </select>
                        <div class="small text-muted">Select a category before starting a conversation; each selection creates a separate conversation session.</div>
                        
                        <!-- Privacy Mode Toggle -->
                        <div class="mt-3 p-3 border rounded" style="background-color: #f8f9fa;">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="privacyModeToggle">
                                <label class="form-check-label" for="privacyModeToggle">
                                    <strong><i class="bi bi-shield-lock me-1"></i>Private Mode (Unmerged)</strong>
                                </label>
                            </div>
                            <div class="small text-muted mt-2">
                                <span id="privacyModeDescription">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <span id="privacyModeOff">Your conversation can be viewed by doctors for advice and emergency response.</span>
                                    <span id="privacyModeOn" style="display: none;">Your conversation is completely private and will not be visible to doctors or external persons.</span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- Thinking Mode Toggle -->
                        <div class="mt-3 p-3 border rounded" style="background-color: #e8f4fd;">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="thinkingModeToggle">
                                <label class="form-check-label" for="thinkingModeToggle">
                                    <strong><i class="bi bi-brain me-1"></i>Thinking Mode</strong>
                                </label>
                            </div>
                            <div class="small text-muted mt-2">
                                <span id="thinkingModeDescription">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    <span id="thinkingModeOff">AI responses appear instantly.</span>
                                    <span id="thinkingModeOn" style="display: none;">See the AI's thought process in real-time as it formulates answers.</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="button" class="btn btn-primary btn-lg" id="startChatBtn" disabled>
                        <i class="bi bi-chat-dots me-2"></i>Start Chat with AI Assistant
                    </button>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div>
                    <i class="bi bi-robot me-2"></i>
                    <span>Medical AI Assistant</span>
                </div>
                <button class="btn btn-sm btn-light" id="endChatBtn">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <div class="message-content">
                        Hello! I'm your medical AI assistant. I'm here to provide general health information and guidance. Remember, I'm not a substitute for professional medical advice. How can I help you today?
                    </div>
                </div>
            </div>
            
            <div class="loading-indicator" id="loadingIndicator">
                <i class="bi bi-arrow-repeat"></i> AI is thinking...
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Type your message here...">
                <input type="file" id="fileInput" style="margin-right:8px;" />
                <button class="btn btn-outline-secondary" id="uploadBtn" title="Attach file">ðŸ“Ž</button>
                <button class="btn btn-danger" id="emergencyBtn" title="Request emergency chat" style="margin-right:6px; display:none;">
                    <i class="bi bi-telephone-fill"></i> Emergency Chat
                </button>
                <button class="btn btn-primary" id="sendBtn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </div>
        </div>

        <!-- Health Dashboard Section -->
        <div class="health-dashboard" id="healthDashboard" style="display:none;">
            <h3 class="mb-4"><i class="bi bi-graph-up me-2"></i>Health Dashboard</h3>
            <div class="row">
                <!-- Health Metrics Dashboard -->
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-graph-up me-2"></i>Health Metrics Trend
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Select Metric Type</label>
                                <select id="metricTypeSelector" class="form-select">
                                    <option value="">-- All Metrics --</option>
                                    <option value="Blood Pressure">Blood Pressure (Systolic)</option>
                                    <option value="Weight">Weight (kg)</option>
                                    <option value="Glucose">Glucose (mg/dL)</option>
                                    <option value="Heart Rate">Heart Rate (bpm)</option>
                                    <option value="Temperature">Temperature (Â°C)</option>
                                </select>
                            </div>
                            <div class="metric-chart">
                                <canvas id="metricsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Section -->
        <div id="riskAssessmentSection" style="display:none;">
            <h3 class="mb-4"><i class="bi bi-exclamation-circle me-2"></i>Health Risk Assessment</h3>
            <div class="row">
                <!-- Risk Score Card -->
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-exclamation-circle me-2"></i>Health Risk Assessment
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div id="riskLevel" class="risk-badge low">
                                    <i class="bi bi-shield-check me-1"></i>LOW RISK
                                </div>
                            </div>
                            <div class="risk-progress">
                                <div class="risk-progress-label">
                                    <span><i class="bi bi-graph-up me-1"></i>Readmission Risk</span>
                                    <span id="readmissionRiskPct">0%</span>
                                </div>
                                <div class="progress">
                                    <div id="readmissionRiskBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="risk-progress">
                                <div class="risk-progress-label">
                                    <span><i class="bi bi-calendar-x me-1"></i>No-Show Risk</span>
                                    <span id="noshowRiskPct">0%</span>
                                </div>
                                <div class="progress">
                                    <div id="noshowRiskBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="risk-progress">
                                <div class="risk-progress-label">
                                    <span><i class="bi bi-exclamation-triangle me-1"></i>Complication Risk</span>
                                    <span id="complicationRiskPct">0%</span>
                                </div>
                                <div class="progress">
                                    <div id="complicationRiskBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

                <!-- Health Metrics Dashboard (moved to Health Dashboard) -->
            </div>

            <!-- Health Metric Entry Form -->
            <div id="logMetricSection" style="display:none;">
            <h3 class="mb-4"><i class="bi bi-plus-circle me-2"></i>Log New Health Metric</h3>
            <div class="row">
                <div class="col-lg-8 mx-auto mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-plus-circle me-2"></i>Log New Health Metric
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Metric Type <span class="text-danger">*</span></label>
                                    <select id="newMetricType" class="form-select" required>
                                        <option value="">-- Select --</option>
                                        <option value="Blood Pressure">Blood Pressure (Systolic in mmHg)</option>
                                        <option value="Weight">Weight (kg)</option>
                                        <option value="Glucose">Glucose (mg/dL)</option>
                                        <option value="Heart Rate">Heart Rate (bpm)</option>
                                        <option value="Temperature">Temperature (Â°C)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Value <span class="text-danger">*</span></label>
                                    <input type="number" id="newMetricValue" class="form-control" placeholder="Enter numeric value" step="0.1" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date <span class="text-danger">*</span></label>
                                    <input type="date" id="newMetricDate" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Notes (optional)</label>
                                    <input type="text" id="newMetricNotes" class="form-control" placeholder="Add any notes...">
                                </div>
                                <div class="col-12">
                                    <button id="submitMetricBtn" class="btn btn-primary w-100">
                                        <i class="bi bi-upload me-2"></i>Log Metric
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Medications & Reminders Section -->
            <div id="medicationsSection" style="display:none;">
                <h3 class="mb-4"><i class="bi bi-capsule me-2"></i>Medications & Reminders</h3>
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-plus-circle me-2"></i>Add Medication
                            </div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label class="form-label">Medication Name</label>
                                        <input id="medName" class="form-control" placeholder="e.g., Metformin" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Dosage</label>
                                        <input id="medDosage" class="form-control" placeholder="e.g., 500mg" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Frequency</label>
                                        <input id="medFrequency" class="form-control" placeholder="e.g., Twice daily" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Times (comma separated)</label>
                                        <input id="medTimes" class="form-control" placeholder="08:00, 20:00" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Start Date</label>
                                        <input id="medStartDate" type="date" class="form-control" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">End Date</label>
                                        <input id="medEndDate" type="date" class="form-control" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Notes</label>
                                        <input id="medNotes" class="form-control" placeholder="Any notes..." />
                                    </div>
                                    <div class="col-12">
                                        <button id="addMedicationBtn" class="btn btn-primary w-100">
                                            <i class="bi bi-check2-circle me-2"></i>Save Medication
                                        </button>
                                    </div>
                                </div>
                                <div id="medicationSaveResult" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div><i class="bi bi-list-check me-2"></i>Your Medications</div>
                                <button id="refreshMedicationsBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body" id="medicationsList">
                                <div class="text-muted">No medications yet.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medication Adherence Section -->
            <div id="adherenceSection" style="display:none;">
                <h3 class="mb-4"><i class="bi bi-check2-circle me-2"></i>Medication Adherence</h3>
                <div class="row">
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div><i class="bi bi-graph-up me-2"></i>30-Day Adherence Summary</div>
                                <button id="refreshAdherenceBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="display-6" id="adherencePercent">0%</div>
                                    <div class="text-muted">Medication adherence rate</div>
                                </div>
                                <div class="mt-3">
                                    <div class="progress">
                                        <div id="adherenceBar" class="progress-bar bg-success" style="width:0%"></div>
                                    </div>
                                </div>
                                <div class="row mt-3" id="adherenceBreakdown">
                                    <div class="col-md-3"><strong>Taken:</strong> <span id="adherenceTaken">0</span></div>
                                    <div class="col-md-3"><strong>Missed:</strong> <span id="adherenceMissed">0</span></div>
                                    <div class="col-md-3"><strong>Skipped:</strong> <span id="adherenceSkipped">0</span></div>
                                    <div class="col-md-3"><strong>Pending:</strong> <span id="adherencePending">0</span></div>
                                </div>
                                <div id="adherenceResult" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical Documents Section -->
            <div id="documentsSection" style="display:none;">
                <h3 class="mb-4"><i class="bi bi-file-earmark-medical me-2"></i>Medical Documents</h3>
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-upload me-2"></i>Upload Document
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <label class="form-label">Document Type</label>
                                    <select id="docType" class="form-select">
                                        <option value="prescription">Prescription</option>
                                        <option value="lab_result">Lab Result</option>
                                        <option value="report">Medical Report</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Choose File</label>
                                    <input id="docFile" type="file" class="form-control" />
                                </div>
                                <button id="uploadDocBtn" class="btn btn-primary w-100">
                                    <i class="bi bi-cloud-upload me-2"></i>Upload
                                </button>
                                <div id="docUploadResult" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div><i class="bi bi-folder2-open me-2"></i>Your Documents</div>
                                <button id="refreshDocsBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body" id="documentsList">
                                <div class="text-muted">No documents uploaded.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Report Section -->
            <div class="row">
                <div class="col-lg-8 mx-auto mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-file-earmark-pdf me-2"></i>Health Report
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Get a comprehensive 90-day health report with your metrics summary and insights.</p>
                            <button id="downloadReportBtn" class="btn btn-outline-primary">
                                <i class="bi bi-download me-2"></i>Generate & Download Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Direct Messages & Notifications -->
            <div id="notificationsSection" style="display:none;">
            <h3 class="mb-4"><i class="bi bi-bell me-2"></i>Notifications</h3>
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-bell me-2"></i>Your Notifications
                        </div>
                        <div class="card-body notification-list" id="patientNotifications">
                            <div class="text-muted">No notifications yet.</div>
                        </div>
                        <div class="card-footer text-end">
                            <button id="markAllNotificationsReadBtn" class="btn btn-sm btn-outline-secondary">Mark all read</button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-gear me-2"></i>Notification Preferences
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="prefMedicationReminders" />
                                        <label class="form-check-label" for="prefMedicationReminders">Medication reminders</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="prefHealthAlerts" />
                                        <label class="form-check-label" for="prefHealthAlerts">Health alerts</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="prefWellnessTips" />
                                        <label class="form-check-label" for="prefWellnessTips">Wellness tips</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="prefEmailNotifications" />
                                        <label class="form-check-label" for="prefEmailNotifications">Email notifications</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="prefSmsNotifications" />
                                        <label class="form-check-label" for="prefSmsNotifications">SMS notifications</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="prefAppointmentReminders" />
                                        <label class="form-check-label" for="prefAppointmentReminders">Appointment reminders</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Timezone</label>
                                    <select id="prefTimezone" class="form-select">
                                        <option value="UTC">UTC</option>
                                        <option value="Africa/Nairobi">Africa/Nairobi</option>
                                        <option value="Europe/London">Europe/London</option>
                                        <option value="Europe/Berlin">Europe/Berlin</option>
                                        <option value="America/New_York">America/New_York</option>
                                        <option value="America/Chicago">America/Chicago</option>
                                        <option value="America/Los_Angeles">America/Los_Angeles</option>
                                        <option value="Asia/Kolkata">Asia/Kolkata</option>
                                        <option value="Asia/Dubai">Asia/Dubai</option>
                                        <option value="Asia/Tokyo">Asia/Tokyo</option>
                                        <option value="Australia/Sydney">Australia/Sydney</option>
                                    </select>
                                </div>
                                <div class="col-12 d-flex gap-2 mt-2">
                                    <button id="saveNotificationPrefsBtn" class="btn btn-primary">
                                        <i class="bi bi-save me-1"></i> Save Preferences
                                    </button>
                                    <button id="verifyChannelsBtn" class="btn btn-outline-primary">
                                        <i class="bi bi-shield-check me-1"></i> Verify Channels
                                    </button>
                                    <button id="sendTestReminderBtn" class="btn btn-outline-secondary">
                                        <i class="bi bi-envelope-check me-1"></i> Send Test Reminder
                                    </button>
                                </div>
                                <div id="notificationPrefsResult" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <div id="messagesSection" style="display:none;">
            <h3 class="mb-4"><i class="bi bi-chat-left-text me-2"></i>Direct Messages</h3>
            <div class="row">
                <div class="col-lg-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-chat-dots me-2"></i>Direct Messages
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="form-label">Select Doctor</label>
                                <select id="dmDoctorSelect" class="form-select"></select>
                            </div>
                            <div class="dm-container">
                                <div id="dmMessages" class="dm-messages"></div>
                                <div class="input-group">
                                    <input type="text" id="dmInput" class="form-control" placeholder="Type a message..." />
                                    <button id="dmSendBtn" class="btn btn-primary">Send</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-muted small">Messages auto-refresh every 5 seconds.</div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Community Forum -->
            <div id="forumSection" style="display:none;">
            <h3 class="mb-4"><i class="bi bi-people me-2"></i>Community Forum</h3>
            <div class="row">
                <div class="col-lg-12 mx-auto mb-4">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-people me-2"></i>Community Forum
                        </div>
                        <div class="card-body">
                            <div class="row g-2 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Filter by Condition</label>
                                    <input id="forumConditionFilter" class="form-control" placeholder="e.g., diabetes" />
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button id="forumRefreshBtn" class="btn btn-outline-secondary w-100">Refresh Posts</button>
                                </div>
                            </div>

                            <div id="forumPosts" class="mb-4">
                                <div class="text-muted">No posts yet.</div>
                            </div>

                            <div class="border-top pt-3">
                                <h6 class="mb-2">Create New Post</h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <input id="forumPostTitle" class="form-control" placeholder="Post title" />
                                    </div>
                                    <div class="col-md-6">
                                        <input id="forumPostCondition" class="form-control" placeholder="Condition tag (optional)" />
                                    </div>
                                    <div class="col-12">
                                        <textarea id="forumPostBody" class="form-control" rows="3" placeholder="Share your question or experience..."></textarea>
                                    </div>
                                    <div class="col-12">
                                        <button id="forumPostBtn" class="btn btn-primary">Post to Forum</button>
                                    </div>
                                </div>
                            </div>

                            <div id="forumPostDetail" class="mt-4" style="display:none;">
                                <h6 id="forumDetailTitle"></h6>
                                <p id="forumDetailBody" class="text-muted"></p>
                                <div id="forumReplies" class="mb-3"></div>
                                <div class="input-group">
                                    <input id="forumReplyBody" class="form-control" placeholder="Write a reply..." />
                                    <button id="forumReplyBtn" class="btn btn-outline-primary">Reply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Nearby Hospitals Map Section -->
            <div id="nearbyHospitalsSection" style="display:none;">
                <h3 class="mb-4"><i class="bi bi-hospital me-2"></i>Nearby Hospitals</h3>
                <div class="row">
                    <div class="col-lg-12 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div><i class="bi bi-map me-2"></i>Find Nearest Hospitals</div>
                                <button id="refreshHospitalsBtn" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Search Radius (km)</label>
                                    <input type="number" id="hospitalSearchRadius" class="form-control" value="10" min="1" max="50" style="max-width: 150px;">
                                </div>
                                <div id="hospitalMapContainer" style="height: 400px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; position: relative;">
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <i class="bi bi-geo-alt" style="font-size: 48px; color: #6c757d;"></i>
                                        <p class="text-muted mt-2">Click "Find Hospitals" to locate nearby healthcare facilities</p>
                                        <button id="findHospitalsBtn" class="btn btn-primary mt-2">
                                            <i class="bi bi-search"></i> Find Hospitals
                                        </button>
                                    </div>
                                    <div id="hospitalMap" style="width: 100%; height: 100%; display: none;"></div>
                                </div>
                                <div id="hospitalsList" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">Â© 2025 Medical AI Assistant. All rights reserved.</p>
            <p class="mb-0">Developed by :EMILIO KAMAU</p>
            <p class="mb-0 mt-2">
                <i class="bi bi-shield-check me-1"></i>
                Your privacy is important to us. No personal health information is stored.
            </p>
        </div>
    </footer>

    <!-- Admin button (fixed position) -->
    <button class="btn btn-outline-danger" onclick="window.location.href='/admin.html'" style="position:fixed;top:20px;right:20px;z-index:999;">Admin</button>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const taskOptions = document.querySelectorAll('.task-option');
            const startChatBtn = document.getElementById('startChatBtn');
            const patientForm = document.getElementById('patientForm');
            const chatContainer = document.getElementById('chatContainer');
            const endChatBtn = document.getElementById('endChatBtn');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const chatMessages = document.getElementById('chatMessages');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const emergencyAlert = document.getElementById('emergencyAlert');
            const emergencyBtn = document.getElementById('emergencyBtn');
            const homeBtn = document.getElementById('homeBtn');
            const backBtn = document.getElementById('backBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const sessionsList = document.getElementById('sessionsList');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const sidebar = document.getElementById('sidebar');
            const mainEl = document.querySelector('main');

            // Sidebar collapse functionality
            const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
            const fixedToggleBtn = document.getElementById('fixedToggleBtn');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            // Load collapse state from localStorage
            const savedCollapseState = localStorage.getItem('sidebar_collapsed') === 'true';
            if (savedCollapseState) {
                sidebar.classList.add('collapsed');
                mainEl.classList.add('collapsed');
            }
            
            // Sidebar collapse button handler
            sidebarCollapseBtn?.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainEl.classList.toggle('collapsed');
                localStorage.setItem('sidebar_collapsed', sidebar.classList.contains('collapsed'));
            });
            
            // Accordion section toggle
            document.querySelectorAll('.sidebar-section-header').forEach(header => {
                header.addEventListener('click', function() {
                    const section = this.parentElement;
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    
                    // Don't toggle sections when sidebar is collapsed
                    if (isCollapsed) return;
                    
                    section.classList.toggle('collapsed');
                    
                    // Save section state
                    const sectionName = section.dataset.section;
                    if (sectionName) {
                        localStorage.setItem(`section_${sectionName}_collapsed`, section.classList.contains('collapsed'));
                    }
                });
            });
            
            // Restore section collapse states
            document.querySelectorAll('.sidebar-section').forEach(section => {
                const sectionName = section.dataset.section;
                if (sectionName) {
                    const isCollapsed = localStorage.getItem(`section_${sectionName}_collapsed`) === 'true';
                    if (isCollapsed) {
                        section.classList.add('collapsed');
                    }
                }
            });
            
            // Mobile sidebar toggle
            
            // Helper function to set active nav item
            function setActiveNavItem(itemId) {
                document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                const activeItem = document.getElementById(itemId);
                if (activeItem) activeItem.classList.add('active');
            }
            
            // Helper function to hide all sections
            function hideAllSections() {
                const sections = ['patientForm', 'chatContainer', 'healthDashboard', 'logMetricSection', 
                                 'riskAssessmentSection', 'messagesSection', 'notificationsSection', 'forumSection',
                                 'medicationsSection', 'adherenceSection', 'documentsSection', 'nearbyHospitalsSection',
                                 'aiDoctorMatchingSection', 'videoConsultationSection', 'appointmentSection'];
                sections.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
            }
            
            // Helper function to show specific section
            function showSection(sectionId, navItemId) {
                hideAllSections();
                const section = document.getElementById(sectionId);
                if (section) section.style.display = 'block';
                if (navItemId) setActiveNavItem(navItemId);
            }

            
            // State
            let selectedTask = null;
            let patientInfo = {};
            let isAuthenticated = false;
            let profileLoaded = false;

            function getToken(){
                return sessionStorage.getItem('jwt_token_patient') || sessionStorage.getItem('jwt_token') || null;
            }

            async function checkAndLoadProfile(){
                const token = getToken();
                if (!token) return;
                isAuthenticated = true;
                try{
                    const resp = await fetch('/profile', { headers: { 'Authorization': 'Bearer ' + token } });
                    if (!resp.ok) return;
                    const j = await resp.json();
                    
                    // Build welcome message based on user role
                    let welcomeText = j.username || 'User';  // Default to username
                    
                    if (j.role === 'doctor') {
                        // For doctors: show full name + specialization
                        if (j.full_name) {
                            welcomeText = j.full_name;
                            if (j.specialization) {
                                welcomeText += ` (${j.specialization})`;
                            }
                        }
                    } else {
                        // For patients: show username
                        welcomeText = j.username || 'Patient';
                    }
                    
                    const welcomeEl = document.getElementById('patientWelcomeName');
                    if (welcomeEl) welcomeEl.textContent = welcomeText;
                    
                    // populate form fields
                    const fullNameEl = document.getElementById('fullName');
                    const ageEl = document.getElementById('age');
                    const genderEl = document.getElementById('gender');
                    const contactEl = document.getElementById('contact');
                    const historyEl = document.getElementById('medicalHistory');
                    if (fullNameEl) fullNameEl.value = j.full_name || j.fullName || '';
                    if (ageEl) ageEl.value = j.age || '';
                    if (genderEl) genderEl.value = j.gender || '';
                    if (contactEl) contactEl.value = j.contact || '';
                    if (historyEl) historyEl.value = j.medical_history || j.medicalHistory || '';
                    patientInfo = {
                        fullName: j.full_name || j.fullName || '',
                        age: j.age || '',
                        gender: j.gender || '',
                        contact: j.contact || '',
                        medicalHistory: j.medical_history || j.medicalHistory || '',
                        task: selectedTask
                    };
                    profileLoaded = true;
                    
                    // Load health dashboard for authenticated patients
                    await loadHealthDashboard();
                    initHealthDashboardListeners();
                    initDirectMessaging();
                    initForum();
                }catch(e){ console.error('Error loading profile:', e); }
            }

            // Appointment actions
            const bookAppointmentBtn = document.getElementById('bookAppointmentBtn');
            const refreshAppointmentsBtn = document.getElementById('refreshAppointmentsBtn');
            if (bookAppointmentBtn) bookAppointmentBtn.addEventListener('click', bookAppointment);
            if (refreshAppointmentsBtn) refreshAppointmentsBtn.addEventListener('click', loadAppointments);

            // Initial data load
            checkAndLoadProfile();
            loadHospitals();
            loadDoctors();
            loadAppointments();
            loadSessions();

            async function loadHospitals(){
                try{
                    const resp = await fetch('/hospitals');
                    const j = await resp.json();
                    const sel = document.getElementById('appointmentHospital');
                    if (!sel) return;
                    sel.innerHTML = '<option value="">-- Select Hospital --</option>';
                    (j.hospitals || []).forEach(h => {
                        const opt = document.createElement('option');
                        opt.value = h.id;
                        opt.textContent = h.name;
                        sel.appendChild(opt);
                    });
                }catch(e){ /* ignore */ }
            }

            async function loadDoctors(){
                try{
                    const resp = await fetch('/doctors');
                    const j = await resp.json();
                    const sel = document.getElementById('appointmentDoctor');
                    const videoSel = document.getElementById('videoConsultationDoctor');
                    
                    const doctorOptions = '<option value="">-- Any Doctor --</option>';
                    const videoDoctorOptions = '<option value="">-- Select a Doctor --</option>';
                    
                    let options = doctorOptions;
                    let videoOptions = videoDoctorOptions;
                    
                    (j.doctors || []).forEach(d => {
                        const optText = `${d.full_name || d.username} ${d.specialization ? '(' + d.specialization + ')' : ''}`;
                        options += `<option value="${d.id}">${optText}</option>`;
                        videoOptions += `<option value="${d.id}">${optText}</option>`;
                    });
                    
                    if (sel) sel.innerHTML = options;
                    if (videoSel) videoSel.innerHTML = videoOptions;
                }catch(e){ /* ignore */ }
            }

            async function loadAppointments(){
                const token = getToken();
                if (!token) return;
                const list = document.getElementById('appointmentList');
                if (!list) return;
                try{
                    const resp = await fetch('/appointments', { headers: { 'Authorization': 'Bearer ' + token } });
                    const j = await resp.json();
                    if (!resp.ok) { list.innerHTML = '<div class="text-danger">Failed to load appointments</div>'; return; }
                    const items = j.appointments || [];
                    if (!items.length) { list.innerHTML = '<p class="text-muted">No appointments found.</p>'; return; }
                    list.innerHTML = items.map(a => `
                        <div class="card mb-2">
                            <div class="card-body">
                                <div><strong>${a.hospital_name || 'Hospital'}</strong></div>
                                <div class="text-muted small">${a.appointment_time || ''} â€¢ ${a.doctor_name || 'Any doctor'}</div>
                                <div class="mt-2">${a.reason || ''}</div>
                            </div>
                        </div>
                    `).join('');
                }catch(e){
                    list.innerHTML = '<div class="text-danger">Network error</div>';
                }
            }

            async function bookAppointment(){
                const token = getToken();
                if (!token) { alert('Please login first'); return; }
                const resultEl = document.getElementById('appointmentResult');
                if (resultEl) resultEl.textContent = '';
                const body = {
                    hospital_id: document.getElementById('appointmentHospital')?.value || null,
                    doctor_id: document.getElementById('appointmentDoctor')?.value || null,
                    appointment_time: document.getElementById('appointmentTime')?.value,
                    reason: document.getElementById('appointmentReason')?.value
                };
                try{
                    const resp = await fetch('/appointments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify(body)
                    });
                    const j = await resp.json();
                    if (!resp.ok) { if (resultEl) resultEl.textContent = 'Error: ' + (j.error || resp.statusText); return; }
                    if (resultEl) resultEl.textContent = 'Appointment requested.';
                    await loadAppointments();
                }catch(e){ if (resultEl) resultEl.textContent = 'Network error'; }
            }

            // AI Doctor Recommendation
            const getRecommendationBtn = document.getElementById('getRecommendationBtn');
            if (getRecommendationBtn) {
                getRecommendationBtn.addEventListener('click', async () => {
                    const token = getToken();
                    if (!token) { alert('Please login first'); return; }
                    
                    const symptoms = document.getElementById('symptomInput')?.value || '';
                    if (!symptoms.trim()) {
                        alert('Please describe your symptoms');
                        return;
                    }
                    
                    const loadingDiv = document.getElementById('recommendationLoading');
                    const resultsDiv = document.getElementById('doctorRecommendations');
                    
                    if (loadingDiv) loadingDiv.style.display = 'block';
                    if (resultsDiv) resultsDiv.innerHTML = '';
                    
                    try {
                        // Request geolocation
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                timeout: 10000,
                                enableHighAccuracy: false
                            });
                        });
                        
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // Get AI recommendations
                        const resp = await fetch('/ai/recommend-doctor', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + token
                            },
                            body: JSON.stringify({
                                symptoms: symptoms,
                                latitude: latitude,
                                longitude: longitude
                            })
                        });
                        
                        if (loadingDiv) loadingDiv.style.display = 'none';
                        
                        const data = await resp.json();
                        
                        if (!resp.ok) {
                            if (resultsDiv) resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to get recommendations'}</div>`;
                            return;
                        }
                        
                        // Display results
                        let html = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Condition Identified:</strong> 
                                <span class="badge bg-primary">${data.condition.primary_specialization}</span>
                                <small class="d-block mt-2">
                                    Urgency Level: <span class="badge bg-${
                                        data.condition.urgency_level === 'emergency' ? 'danger' :
                                        data.condition.urgency_level === 'urgent' ? 'warning' :
                                        data.condition.urgency_level === 'moderate' ? 'info' : 'success'
                                    }">${data.condition.urgency_level.toUpperCase()}</span>
                                </small>
                            </div>
                            <h6 class="mt-3">Recommended Doctors (Ranked by Match)</h6>
                        `;
                        
                        if (data.recommended_doctors.length === 0) {
                            html += '<p class="text-muted">No doctors found in your area. Try a different location.</p>';
                        } else {
                            html += '<div class="list-group">';
                            data.recommended_doctors.forEach(doc => {
                                const matchPercent = Math.min(100, Math.round(doc.match_score));
                                html += `
                                    <button type="button" class="list-group-item list-group-item-action" 
                                            onclick="selectRecommendedDoctor(${doc.id}, '${doc.name.replace(/'/g, "\\'")}', ${doc.hospital_id})">
                                        <div class="d-flex justify-content-between align-items-start w-100">
                                            <div>
                                                <h6 class="mb-1"><strong>${doc.name}</strong></h6>
                                                <p class="mb-1 text-muted small">
                                                    <i class="bi bi-hospital"></i> ${doc.hospital_name}
                                                </p>
                                                <p class="mb-0 small">
                                                    <i class="bi bi-briefcase"></i> ${doc.specialization} â€¢ 
                                                    <i class="bi bi-award"></i> ${doc.experience_years} years
                                                </p>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-success mb-2" style="font-size: 0.9rem;">${matchPercent}% Match</span>
                                                <br>
                                                <small class="text-muted d-block">
                                                    <i class="bi bi-geo-alt"></i> ${doc.distance_km} km
                                                </small>
                                                <small class="text-warning d-block">
                                                    <i class="bi bi-star-fill"></i> ${doc.rating}/5
                                                </small>
                                            </div>
                                        </div>
                                    </button>
                                `;
                            });
                            html += '</div>';
                        }
                        
                        if (resultsDiv) resultsDiv.innerHTML = html;
                        
                    } catch (error) {
                        if (loadingDiv) loadingDiv.style.display = 'none';
                        console.error('Error:', error);
                        
                        let errorMsg = 'Failed to get recommendations. ';
                        if (error.code === 1) {
                            errorMsg += 'Please enable location access in your browser settings.';
                        } else if (error.code === 2) {
                            errorMsg += 'Unable to retrieve your location. Please check your GPS or try again.';
                        } else if (error.code === 3) {
                            errorMsg += 'Location request timed out. Please try again.';
                        } else {
                            errorMsg += error.message || 'Please try again.';
                        }
                        
                        if (resultsDiv) resultsDiv.innerHTML = `<div class="alert alert-warning">${errorMsg}</div>`;
                    }
                });
            }
            
            // Helper function to select a recommended doctor
            window.selectRecommendedDoctor = function(doctorId, doctorName, hospitalId) {
                // Pre-fill the appointment form
                const hospitalSelect = document.getElementById('appointmentHospital');
                const doctorSelect = document.getElementById('appointmentDoctor');
                const reasonInput = document.getElementById('appointmentReason');
                
                if (hospitalSelect && hospitalId) {
                    hospitalSelect.value = hospitalId;
                }
                if (doctorSelect) {
                    doctorSelect.value = doctorId;
                }
                if (reasonInput) {
                    reasonInput.focus();
                }
                
                // Scroll to appointment form
                document.querySelector('[data-section="appointments"]')?.scrollIntoView({ behavior: 'smooth' });
            };
            
            // Video Consultation Handlers
            const videoDoctorSelect = document.getElementById('videoConsultationDoctor');
            const videoDateInput = document.getElementById('videoConsultationDate');
            const videoSlotsDiv = document.getElementById('videoSlots');
            const scheduleVideoBtn = document.getElementById('scheduleVideoBtn');
            
            // Populate video consultation doctor list (same as appointment doctors)
            if (videoDoctorSelect) {
                videoDoctorSelect.addEventListener('change', loadVideoSlots);
            }
            
            if (videoDateInput) {
                videoDateInput.addEventListener('change', loadVideoSlots);
            }
            
            async function loadVideoSlots() {
                const doctorId = videoDoctorSelect?.value;
                const date = videoDateInput?.value;
                
                if (!doctorId || !date) {
                    if (videoSlotsDiv) videoSlotsDiv.innerHTML = '<p class="text-muted small">Select a doctor and date to view available slots</p>';
                    return;
                }
                
                try {
                    const token = getToken();
                    const resp = await fetch(`/doctor/${doctorId}/available-slots`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ date: date })
                    });
                    
                    const data = await resp.json();
                    
                    if (!data.slots || data.slots.length === 0) {
                        if (videoSlotsDiv) videoSlotsDiv.innerHTML = '<p class="text-muted small">No available slots on this date</p>';
                        return;
                    }
                    
                    let html = '';
                    data.slots.forEach((slot, idx) => {
                        const startTime = new Date(slot.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        html += `
                            <button type="button" class="btn btn-outline-primary btn-sm slot-btn" 
                                    data-start="${slot.start_time}">
                                ${startTime}
                            </button>
                        `;
                    });
                    
                    if (videoSlotsDiv) {
                        videoSlotsDiv.innerHTML = html;
                        
                        // Add click handler to slot buttons
                        document.querySelectorAll('.slot-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('active'));
                                e.target.classList.add('active');
                                e.target.classList.remove('btn-outline-primary');
                                e.target.classList.add('btn-primary');
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error loading slots:', error);
                    if (videoSlotsDiv) videoSlotsDiv.innerHTML = '<p class="text-danger small">Failed to load available slots</p>';
                }
            }
            
            if (scheduleVideoBtn) {
                scheduleVideoBtn.addEventListener('click', async () => {
                    const token = getToken();
                    if (!token) { alert('Please login first'); return; }
                    
                    const doctorId = videoDoctorSelect?.value;
                    const selectedSlot = document.querySelector('.slot-btn.active');
                    const reason = document.getElementById('videoConsultationReason')?.value || '';
                    const duration = parseInt(document.getElementById('videoConsultationDuration')?.value || '30');
                    
                    if (!doctorId || !selectedSlot) {
                        alert('Please select a doctor and available time slot');
                        return;
                    }
                    
                    const resultDiv = document.getElementById('videoResult');
                    if (resultDiv) resultDiv.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Scheduling...';
                    
                    try {
                        const resp = await fetch('/schedule-video-consultation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + token
                            },
                            body: JSON.stringify({
                                doctor_id: parseInt(doctorId),
                                start_time: selectedSlot.getAttribute('data-start'),
                                duration_minutes: duration,
                                reason: reason
                            })
                        });
                        
                        const data = await resp.json();
                        
                        if (!resp.ok) {
                            if (resultDiv) resultDiv.innerHTML = `<div class="alert alert-danger mt-2">${data.error || 'Failed to schedule'}</div>`;
                            return;
                        }
                        
                        // Show success with Google Meet link
                        if (resultDiv) resultDiv.innerHTML = '';
                        
                        const linkSection = document.getElementById('videoMeetLinkSection');
                        const meetLink = document.getElementById('googleMeetLink');
                        const timeDisplay = document.getElementById('videoConsultationTime');
                        
                        if (linkSection && meetLink && timeDisplay) {
                            const startTime = new Date(data.consultation_details.start_time)
                                .toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                            
                            timeDisplay.textContent = `${startTime} (${data.consultation_details.duration_minutes} minutes)`;
                            meetLink.href = data.google_meet_link;
                            linkSection.style.display = 'block';
                            
                            // Scroll to show the meet link
                            linkSection.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                    } catch (error) {
                        console.error('Error:', error);
                        if (resultDiv) resultDiv.innerHTML = '<div class="alert alert-danger mt-2">Network error. Please try again.</div>';
                    }
                });
            }
            
            // Task selection - enable chat immediately when task is selected
            taskOptions.forEach(option => {
                option.addEventListener('click', function() {
                    taskOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedTask = this.dataset.task;
                    
                    // Enable start chat button
                    startChatBtn.disabled = false;
                    
                    // Show emergency alert for symptom checker
                    if (selectedTask === 'symptoms') {
                        emergencyAlert.style.display = 'block';
                    } else {
                        emergencyAlert.style.display = 'none';
                    }
                });
            });
            
            // Start chat
            startChatBtn.addEventListener('click', async function() {
                // Load profile if authenticated
                await checkAndLoadProfile();
                
                // Use default values if no profile loaded
                if (!patientInfo || !patientInfo.fullName) {
                    patientInfo = {
                        fullName: 'User',
                        age: '',
                        gender: '',
                        contact: '',
                        medicalHistory: '',
                        task: selectedTask
                    };
                }
                
                // Hide form and show chat
                patientForm.style.display = 'none';
                chatContainer.style.display = 'block';
                
                // Add initial AI message based on selected task
                let initialMessage = getInitialMessage(selectedTask);
                addAIMessage(initialMessage);
                // hide emergency button initially
                emergencyBtn.style.display = 'none';
                // load session history (server for logged-in, else local)
                loadSessions();
                // initialize sidebar collapsed state for small screens
                if (window.innerWidth <= 768) {
                    sidebar.classList.add('collapsed');
                    mainEl.classList.add('collapsed');
                }
            });

            // Help category dropdown: create sessions per-category and handle emergency
            const helpSelect = document.getElementById('helpCategory');
            const privacyToggle = document.getElementById('privacyModeToggle');
            const privacyModeOn = document.getElementById('privacyModeOn');
            const privacyModeOff = document.getElementById('privacyModeOff');
            const thinkingToggle = document.getElementById('thinkingModeToggle');
            const thinkingModeOn = document.getElementById('thinkingModeOn');
            const thinkingModeOff = document.getElementById('thinkingModeOff');
            
            // Privacy mode toggle handler
            if (privacyToggle) {
                privacyToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        privacyModeOff.style.display = 'none';
                        privacyModeOn.style.display = 'inline';
                    } else {
                        privacyModeOff.style.display = 'inline';
                        privacyModeOn.style.display = 'none';
                    }
                });
            }
            
            // Thinking mode toggle handler
            if (thinkingToggle) {
                thinkingToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        thinkingModeOff.style.display = 'none';
                        thinkingModeOn.style.display = 'inline';
                    } else {
                        thinkingModeOff.style.display = 'inline';
                        thinkingModeOn.style.display = 'none';
                    }
                });
            }
            
            if (helpSelect) {
                helpSelect.addEventListener('change', async (e) => {
                    const category = e.target.value;
                    if (!category) return;

                    // If Emergency selected, create session and notify clinicians immediately
                    if (category === 'emergency') {
                        const calmText = "We're here to help. If you feel unsafe or are in immediate danger, please call emergency services right away.";
                        const isPrivate = privacyToggle && privacyToggle.checked;
                        try {
                            const res = await fetch('/sessions', {
                                method: 'POST', headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({task: category, patient_info: null, is_private: isPrivate})
                            });
                            const j = await res.json();
                            if (j.session_id) {
                                // show calming message locally and notify server
                                addAIMessage(calmText);
                                await fetch('/emergency_alert', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({session_id: j.session_id, note: 'Patient started Emergency Chat via category selection'})});
                                window.__CHAT_SESSION_ID = j.session_id;
                                addSessionToSidebar({ id: j.session_id, patient_name: patientInfo.fullName || '', created_at: new Date().toISOString() });
                                // open chat UI
                                patientForm.style.display = 'none';
                                chatContainer.style.display = 'block';
                                emergencyBtn.style.display = 'inline-block';
                            }
                        } catch (err) {
                            console.error('Emergency session create failed', err);
                        }
                        return;
                    }

                    // Non-emergency: create a session and start chat
                    const isPrivate = privacyToggle && privacyToggle.checked;
                    try {
                        const res = await fetch('/sessions', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({task: category, patient_info: null, is_private: isPrivate}) });
                        const j = await res.json();
                        if (j.session_id) {
                            window.__CHAT_SESSION_ID = j.session_id;
                            addSessionToSidebar({ id: j.session_id, patient_name: patientInfo.fullName || '', created_at: new Date().toISOString() });
                            // open chat UI and show initial message for the category
                            patientForm.style.display = 'none';
                            chatContainer.style.display = 'block';
                            const initial = getInitialMessage(category);
                            addAIMessage(initial);
                        } else {
                            alert('Unable to create session. Please try again.');
                        }
                    } catch (err) {
                        console.error('Session create failed', err);
                        alert('Unable to create session.');
                    }
                });
            }

            // Sidebar toggle handled by fixed toggle button (keeps the button visible)
            fixedToggleBtn?.addEventListener('click', function(){
                if (window.innerWidth <= 768) {
                    // Mobile: slide-in overlay menu
                    const isOpen = sidebar.classList.contains('show');
                    if (isOpen) {
                        sidebar.classList.remove('show');
                        document.getElementById('sidebarOverlay').style.display = 'none';
                    } else {
                        sidebar.classList.add('show');
                        document.getElementById('sidebarOverlay').style.display = 'block';
                    }
                } else {
                    // Desktop: classic collapse
                    sidebar.classList.toggle('collapsed');
                    mainEl.classList.toggle('collapsed');
                    try { sessionStorage.setItem('sidebar_collapsed', sidebar.classList.contains('collapsed') ? '1' : '0'); } catch(e){}
                }
            });

            // Close sidebar when overlay is clicked
            document.getElementById('sidebarOverlay').addEventListener('click', () => {
                sidebar.classList.remove('show');
                document.getElementById('sidebarOverlay').style.display = 'none';
            });

            // Login / Logout
            // Go to unified auth page
            loginBtn.addEventListener('click', function(){ window.location.href = '/auth'; });
            logoutBtn.addEventListener('click', doLogout);

            // Idle logout: 5 minutes of inactivity
            let idleTimeout = null;
            const IDLE_MS = 5 * 60 * 1000; // 5 minutes
            function resetIdleTimer(){
                if (idleTimeout) clearTimeout(idleTimeout);
                idleTimeout = setTimeout(() => {
                    // perform logout due to inactivity
                    doLogout(true);
                }, IDLE_MS);
            }
            function doLogout(isIdle=false){
                // Clear JWTs and role info; keep local sessions
                sessionStorage.removeItem('jwt_token');
                sessionStorage.removeItem('jwt_token_patient');
                sessionStorage.removeItem('user_role');
                // Optionally notify server of logout (not required for prototype)
                if (!isIdle) {
                    // user-initiated logout
                }
                window.location.href = '/';
            }
            // Reset timer on common user interactions
            ['click','mousemove','keydown','touchstart'].forEach(evt => document.addEventListener(evt, resetIdleTimer));
            resetIdleTimer();

            // Patient auth helper: return existing token if present; do not force login prompts
            async function ensurePatientAuth() {
                // Prefer explicit patient token, fall back to any JWT (e.g., one-time login)
                const token = sessionStorage.getItem('jwt_token_patient') || sessionStorage.getItem('jwt_token') || null;
                return token;
            }
            
            // End chat
            endChatBtn.addEventListener('click', function() {
                chatContainer.style.display = 'none';
                patientForm.style.display = 'block';
                // Clear chat messages except the first one
                while (chatMessages.children.length > 1) {
                    chatMessages.removeChild(chatMessages.lastChild);
                }
            });
            
            // Send message
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            async function sendMessage() {
                const message = chatInput.value.trim();
                if (!message) return;

                // Add user message
                addUserMessage(message);
                chatInput.value = '';

                // Check if thinking mode is enabled
                const thinkingMode = thinkingToggle && thinkingToggle.checked;

                // Show loading indicator (or thinking indicator if thinking mode)
                if (thinkingMode) {
                    loadingIndicator.innerHTML = '<i class="bi bi-brain"></i> AI is thinking...';
                }
                loadingIndicator.style.display = 'block';

                // Try to include JWT if present; do not block anonymous users from chatting
                const token = await ensurePatientAuth();

                // Build payload. If an authenticated profile is loaded, we don't need to include patient_info.
                const isPrivate = privacyToggle && privacyToggle.checked;
                const payload = { message: message, session_id: window.__CHAT_SESSION_ID || null, thinking_mode: thinkingMode, is_private: isPrivate };
                if (!isAuthenticated || !profileLoaded) payload.patient_info = patientInfo;

                try {
                    // Build headers; include Authorization only when we have a token
                    const headers = { 'Content-Type': 'application/json' };
                    if (token) headers['Authorization'] = 'Bearer ' + token;
                    
                    if (thinkingMode) {
                        // Use streaming for thinking mode
                        await sendMessageStreaming(payload, headers);
                    } else {
                        // Use regular request
                        const resp = await fetch('/chat', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(payload)
                        });

                        const data = await resp.json();
                        loadingIndicator.style.display = 'none';

                        if (!resp.ok) {
                            addAIMessage(`<div class="text-danger">Error: ${data.error || 'Unknown error'}</div>`);
                            return;
                        }

                        // Insert AI reply (HTML is returned from server)
                        addAIMessage(data.reply_html || data.reply_text || '');

                        // If server signaled an emergency, show the emergency chat button and a calm prompt
                        if (data.emergency) {
                            emergencyBtn.style.display = 'inline-block';
                            addAIMessage(`<div class="text-warning">If you'd like, you can request an emergency chat with a clinician. <button class="btn btn-sm btn-danger" onclick="requestEmergencyChat()">Request Emergency Chat</button></div>`);
                        }

                        // Store session id for continued conversation
                        if (data.session_id) {
                            window.__CHAT_SESSION_ID = data.session_id;
                            // add to server-side sessions list if authenticated; otherwise store locally
                            try { addSessionToSidebar({ id: data.session_id, patient_name: patientInfo.fullName || '', created_at: new Date().toISOString() }); } catch(e){}
                        }
                    }
                } catch (err) {
                    loadingIndicator.style.display = 'none';
                    addAIMessage('<div class="text-danger">Network error: could not reach /chat endpoint.</div>');
                }
            }

            // Streaming message function for thinking mode
            async function sendMessageStreaming(payload, headers) {
                try {
                    const resp = await fetch('/chat/stream', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) {
                        const data = await resp.json().catch(() => ({error: 'Unknown error'}));
                        loadingIndicator.style.display = 'none';
                        addAIMessage(`<div class="text-danger">Error: ${data.error || 'Unknown error'}</div>`);
                        return;
                    }

                    // Create a streaming message container
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message ai thinking-message';
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <div class="thinking-indicator">
                                <i class="bi bi-brain"></i>
                                <span>AI is thinking...</span>
                            </div>
                            <div class="streaming-content"></div>
                        </div>
                    `;
                    chatMessages.appendChild(messageDiv);
                    const streamingContent = messageDiv.querySelector('.streaming-content');
                    const thinkingIndicator = messageDiv.querySelector('.thinking-indicator');

                    // Read the streaming response
                    const reader = resp.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let fullResponse = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line in buffer

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') {
                                    // Stream ended
                                    thinkingIndicator.style.display = 'none';
                                    loadingIndicator.style.display = 'none';
                                    break;
                                }
                                try {
                                    const chunk = JSON.parse(data);
                                    if (chunk.content) {
                                        fullResponse += chunk.content;
                                        streamingContent.innerHTML = fullResponse.replace(/\n/g, '<br>');
                                        // Scroll to bottom
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                    }
                                    if (chunk.emergency) {
                                        emergencyBtn.style.display = 'inline-block';
                                    }
                                } catch (e) {
                                    console.error('Error parsing streaming chunk:', e);
                                }
                            }
                        }
                    }

                    // Store session id for continued conversation
                    if (payload.session_id) {
                        window.__CHAT_SESSION_ID = payload.session_id;
                        try { addSessionToSidebar({ id: payload.session_id, patient_name: patientInfo.fullName || '', created_at: new Date().toISOString() }); } catch(e){}
                    }

                } catch (err) {
                    loadingIndicator.style.display = 'none';
                    addAIMessage('<div class="text-danger">Network error during streaming.</div>');
                }
            }

            // Load sessions: if authenticated, fetch from server /my_sessions; otherwise load from localStorage
            async function loadSessions(){
                sessionsList.innerHTML = '<div class="small text-muted">Loading...</div>';
                const token = sessionStorage.getItem('jwt_token_patient') || sessionStorage.getItem('jwt_token') || null;
                if (token){
                    try{
                        const resp = await fetch('/my_sessions', { headers: { 'Authorization': 'Bearer ' + token }});
                        const j = await resp.json();
                        renderSessions(j.sessions || []);
                        return;
                    }catch(e){ /* fall back to local */ }
                }
                // local sessions for anonymous users
                const ls = JSON.parse(localStorage.getItem('local_sessions') || '[]');
                renderSessions(ls || []);
            }

            function renderSessions(sessions){
                sessionsList.innerHTML = '';
                if (!sessions || sessions.length === 0){
                    sessionsList.innerHTML = '<div class="small text-muted">No conversations yet</div>';
                    return;
                }
                sessions.forEach(s => {
                    const el = document.createElement('div');
                    el.className = 'mb-2';
                    // Use AI-generated title if available, otherwise fallback to task or patient_name
                    const title = s.title || s.task || s.patient_name || ('Chat ' + s.id);
                    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><a href="#" data-id="${s.id}" class="session-link" style="text-decoration:none;color:#0d6efd;font-weight:500">${escapeHtml(title)}</a><span class="small text-muted">${(s.created_at||'').slice(0,16).replace('T',' ')}</span></div>`;
                    sessionsList.appendChild(el);
                });
                // attach click handlers
                document.querySelectorAll('.session-link').forEach(a => {
                    a.addEventListener('click', async function(e){
                        e.preventDefault();
                        const sid = this.dataset.id;
                        // load messages for session
                        await loadSessionMessages(sid);
                        // show chat
                        patientForm.style.display = 'none';
                        chatContainer.style.display = 'block';
                    });
                });
            }

            // load messages for a session id (server-side if authenticated, else attempt localStorage)
            async function loadSessionMessages(sid){
                const token = sessionStorage.getItem('jwt_token_patient') || sessionStorage.getItem('jwt_token') || null;
                chatMessages.innerHTML = '';
                if (token){
                    try{
                        const resp = await fetch(`/sessions/${sid}/messages`, { headers: { 'Authorization': 'Bearer ' + token }});
                        const j = await resp.json();
                        if (!resp.ok) { addAIMessage('<div class="text-danger">Unable to load conversation</div>'); return }
                        j.messages.forEach(m => {
                            if (m.role === 'user') addUserMessage(m.content);
                            else addAIMessage(m.content);
                        });
                        window.__CHAT_SESSION_ID = sid;
                        return;
                    }catch(e){ /* fall back to local */ }
                }
                // localStorage fallback
                const ls = JSON.parse(localStorage.getItem('local_sessions') || '[]');
                const conv = ls.find(x => String(x.id) === String(sid));
                if (!conv){ addAIMessage('<div class="text-muted">Conversation not found locally.</div>'); return }
                (conv.messages||[]).forEach(m => { if (m.role==='user') addUserMessage(m.content); else addAIMessage(m.content); });
                window.__CHAT_SESSION_ID = sid;
            }

            function addSessionToSidebar(s){
                // if authenticated, reload sessions from server; otherwise persist locally
                const token = sessionStorage.getItem('jwt_token_patient') || sessionStorage.getItem('jwt_token') || null;
                if (token) { loadSessions(); return; }
                const ls = JSON.parse(localStorage.getItem('local_sessions') || '[]');
                // avoid duplicates
                if (!ls.find(x => String(x.id) === String(s.id))){
                    ls.unshift({ id: s.id, patient_name: s.patient_name || '', created_at: s.created_at || new Date().toISOString(), messages: s.messages || [] });
                    localStorage.setItem('local_sessions', JSON.stringify(ls));
                    renderSessions(ls);
                }
            }

            // Home / Back / New Chat handlers
            homeBtn.addEventListener('click', function(){
                const healthDashboard = document.getElementById('healthDashboard');
                const patientForm = document.getElementById('patientForm');
                
                if (isAuthenticated && healthDashboard) {
                    showSection('healthDashboard', 'homeBtn');
                } else {
                    showSection('patientForm', 'homeBtn');
                }
            });
            
            // Navigation handlers for sidebar items
            document.getElementById('healthDashboardBtn')?.addEventListener('click', () => {
                showSection('healthDashboard', 'healthDashboardBtn');
            });
            
            document.getElementById('logMetricBtn')?.addEventListener('click', () => {
                showSection('logMetricSection', 'logMetricBtn');
            });
            
            document.getElementById('riskAssessmentBtn')?.addEventListener('click', () => {
                showSection('riskAssessmentSection', 'riskAssessmentBtn');
            });

            document.getElementById('medicationsBtn')?.addEventListener('click', () => {
                showSection('medicationsSection', 'medicationsBtn');
                loadMedications();
            });

            document.getElementById('adherenceBtn')?.addEventListener('click', () => {
                showSection('adherenceSection', 'adherenceBtn');
                loadAdherence();
            });

            document.getElementById('documentsBtn')?.addEventListener('click', () => {
                showSection('documentsSection', 'documentsBtn');
                loadDocuments();
            });
            
            document.getElementById('messagesBtn')?.addEventListener('click', () => {
                showSection('messagesSection', 'messagesBtn');
            });
            
            document.getElementById('notificationsBtn')?.addEventListener('click', () => {
                showSection('notificationsSection', 'notificationsBtn');
                loadNotificationPreferences();
            });
            
            document.getElementById('forumBtn')?.addEventListener('click', () => {
                showSection('forumSection', 'forumBtn');
            });
            
            // Navigation helpers
            function hideAllSections() {
                const sections = ['healthDashboard', 'logMetricSection', 'riskAssessmentSection', 
                                  'forumSection', 'notificationsSection', 'messagesSection',
                                  'medicationsSection', 'adherenceSection', 'documentsSection', 'nearbyHospitalsSection',
                                  'aiDoctorMatchingSection', 'videoConsultationSection', 'appointmentSection'];
                sections.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                const patientForm = document.getElementById('patientForm');
                const chatContainer = document.getElementById('chatContainer');
                if (patientForm) patientForm.style.display = 'none';
                if (chatContainer) chatContainer.style.display = 'none';
            }
            
            function showSection(sectionId) {
                hideAllSections();
                const el = document.getElementById(sectionId);
                if (el) el.style.display = 'block';
            }
            
            // Sidebar navigation handlers
            const healthDashboardBtn = document.getElementById('healthDashboardBtn');
            if (healthDashboardBtn) {
                healthDashboardBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to view health dashboard');
                        return;
                    }
                    showSection('healthDashboard');
                });
            }
            
            const logMetricBtn = document.getElementById('logMetricBtn');
            if (logMetricBtn) {
                logMetricBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to log health metrics');
                        return;
                    }
                    showSection('logMetricSection');
                });
            }
            
            const riskAssessmentBtn = document.getElementById('riskAssessmentBtn');
            if (riskAssessmentBtn) {
                riskAssessmentBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to view risk assessment');
                        return;
                    }
                    showSection('riskAssessmentSection');
                });
            }

            const medicationsBtn = document.getElementById('medicationsBtn');
            if (medicationsBtn) {
                medicationsBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to manage medications');
                        return;
                    }
                    showSection('medicationsSection');
                    loadMedications();
                });
            }

            const adherenceBtn = document.getElementById('adherenceBtn');
            if (adherenceBtn) {
                adherenceBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to view adherence');
                        return;
                    }
                    showSection('adherenceSection');
                    loadAdherence();
                });
            }

            const documentsBtn = document.getElementById('documentsBtn');
            if (documentsBtn) {
                documentsBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to access documents');
                        return;
                    }
                    showSection('documentsSection');
                    loadDocuments();
                });
            }
            
            const forumBtn = document.getElementById('forumBtn');
            if (forumBtn) {
                forumBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to access community forum');
                        return;
                    }
                    showSection('forumSection');
                });
            }
            
            const notificationsBtn = document.getElementById('notificationsBtn');
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to view notifications');
                        return;
                    }
                    showSection('notificationsSection');
                    loadNotificationPreferences();
                });
            }
            
            const messagesBtn = document.getElementById('messagesBtn');
            if (messagesBtn) {
                messagesBtn.addEventListener('click', function() {
                    if (!isAuthenticated) {
                        alert('Please login to view messages');
                        return;
                    }
                    showSection('messagesSection');
                });
            }
            
            const profileBtn = document.getElementById('profileBtn');
            if (profileBtn) {
                profileBtn.addEventListener('click', function(){ window.location.href = '/profile.html'; });
            }
            newChatBtn.addEventListener('click', function(){
                // clear current session and show form
                window.__CHAT_SESSION_ID = null;
                chatMessages.innerHTML = '<div class="message ai"><div class="message-content">Hello! I\'m your medical AI assistant. How can I help you today?</div></div>';
                chatContainer.style.display = 'none';
                patientForm.style.display = 'block';
            });

            // Healthcare Services section handlers
            const aiDoctorMatchingBtn = document.getElementById('aiDoctorMatchingBtn');
            const videoConsultationBtn = document.getElementById('videoConsultationBtn');
            const appointmentBtn = document.getElementById('appointmentBtn');
            
            if (aiDoctorMatchingBtn) {
                aiDoctorMatchingBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    showSection('aiDoctorMatchingSection', 'aiDoctorMatchingBtn');
                });
            }
            
            if (videoConsultationBtn) {
                videoConsultationBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    showSection('videoConsultationSection', 'videoConsultationBtn');
                });
            }
            
            if (appointmentBtn) {
                appointmentBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    showSection('appointmentSection', 'appointmentBtn');
                });
            }

            // Request an emergency chat - notify clinicians and show calming guidance
            window.requestEmergencyChat = async function() {
                const sessionId = window.__CHAT_SESSION_ID || null;
                
                // Request location permission
                let location = null;
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            });
                        });
                        location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        console.log('Location obtained:', location);
                    } catch (err) {
                        console.warn('Location access denied or unavailable:', err);
                        addAIMessage('<div class="alert alert-info"><i class="bi bi-geo-alt"></i> Location sharing was denied. Emergency alert will be sent without location.</div>');
                    }
                }
                
                try {
                    const resp = await fetch('/emergency_alert', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ 
                            session_id: sessionId, 
                            patient_info: patientInfo,
                            location: location 
                        }) 
                    });
                    const j = await resp.json();
                    if (!resp.ok) { 
                        addAIMessage(`<div class="text-danger">Unable to request emergency chat: ${j.error || resp.statusText}</div>`); 
                        return; 
                    }
                    
                    // Calm, reassuring message
                    let message = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle-fill"></i> A clinician has been notified and will review your session shortly.';
                    if (j.location_shared) {
                        message += ' <strong>Your location has been shared with emergency responders.</strong>';
                    }
                    message += ' If you are in immediate danger, call local emergency services now. Try to breathe slowly â€” help is being requested.</div>';
                    addAIMessage(message);
                    
                    // hide the emergency button after requesting
                    emergencyBtn.style.display = 'none';
                } catch (e) {
                    addAIMessage('<div class="text-danger">Network error while requesting emergency chat.</div>');
                }
            }

            // Upload attachment for current session
            document.getElementById('uploadBtn').addEventListener('click', async () => {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files || !fileInput.files.length) return alert('Choose a file first');
                const file = fileInput.files[0];
                const sessionId = window.__CHAT_SESSION_ID;
                if (!sessionId) return alert('Please start a chat first to create a session.');

                const token = sessionStorage.getItem('jwt_token_patient');
                if (!token) return alert('You must be logged in as patient to upload files.');

                const form = new FormData();
                form.append('file', file);
                form.append('session_id', sessionId);

                try {
                    const resp = await fetch('/upload', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: form });
                    const j = await resp.json();
                    if (!resp.ok) return alert('Upload failed: ' + (j.error || resp.statusText));
                    addAIMessage(`<div class="text-success">Attachment uploaded: ${j.original_name}</div>`);
                    // clear file input
                    fileInput.value = '';
                } catch (e) {
                    alert('Upload error');
                }
            });
            
            function addUserMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message user';
                messageElement.innerHTML = `<div class="message-content">${escapeHtml(message)}</div>`;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function addAIMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message ai';
                messageElement.innerHTML = `<div class="message-content">${message}</div>`;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function getInitialMessage(task) {
                const messages = {
                    'symptoms': `Hello ${patientInfo.fullName}! I'm here to help you with your symptoms. Please describe what you're experiencing in detail, including when it started, severity, and any other relevant information. Remember, if you're experiencing severe symptoms, please seek immediate medical attention.`,
                    'medication': `Hello ${patientInfo.fullName}! I can provide information about medications, including usage instructions, potential side effects, and general information. Please note that I cannot prescribe medication or replace your doctor's advice. What medication would you like to know about?`,
                    'health-education': `Hello ${patientInfo.fullName}! I'm here to provide health education on various topics. What health condition or topic would you like to learn more about today?`,
                    'lifestyle': `Hello ${patientInfo.fullName}! I can provide advice on diet, exercise, and healthy living habits. What aspect of lifestyle would you like to discuss today?`,
                    'mental-health': `Hello ${patientInfo.fullName}! I'm here to provide resources and guidance for mental well-being. Please remember that for serious mental health concerns, it's important to consult with a healthcare professional. How can I support you today?`,
                    'other': `Hello ${patientInfo.fullName}! I'm here to help with any health-related questions or concerns you might have. What would you like to discuss today?`
                };
                
                return messages[task] || messages['other'];
            }
            
            function checkEmergencyKeywords(message) {
                const emergencyKeywords = [
                    'chest pain', 'difficulty breathing', 'severe bleeding', 
                    'unconscious', 'fainting', 'loss of consciousness',
                    'severe pain', 'suicidal', 'heart attack', 'stroke',
                    'emergency', "can't breathe", 'paralysis', 'confusion',
                    'high fever', 'seizure', 'allergic reaction', 'swelling'
                ];
                
                const lowerMessage = message.toLowerCase();
                return emergencyKeywords.some(keyword => lowerMessage.includes(keyword));
            }
            
            function getEmergencyResponse() {
                return `<div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Emergency Warning:</strong> Based on your message, you may be experiencing a medical emergency. Please seek immediate medical attention by:
                    <ul>
                        <li>Calling emergency services (911 in the US)</li>
                        <li>Going to the nearest emergency room</li>
                        <li>Having someone take you to a doctor immediately</li>
                    </ul>
                    Do not wait for a response from this AI system in an emergency situation.
                </div>`;
            }
            
            function generateSimulatedResponse(message, task) {
                // This is a placeholder for your actual API call
                // In a real implementation, you would send the message and patient info to your backend
                // which would then call the Gemini API
                
                const responses = {
                    'symptoms': `Based on the symptoms you've described, there are several possible conditions that could be causing your discomfort. However, I'm not able to provide a diagnosis. It's important to consult with a healthcare professional who can properly evaluate your condition. In the meantime, you might consider getting adequate rest and staying hydrated. If your symptoms worsen or don't improve in a few days, please seek medical attention.`,
                    
                    'medication': `The medication you're asking about is commonly used to treat certain conditions. It's important to take it exactly as prescribed by your healthcare provider. Common side effects may include nausea, dizziness, or headache. Be sure to read the medication guide provided by your pharmacist and ask your doctor or pharmacist if you have any questions. Never share your medication with others or take more than the prescribed dose.`,
                    
                    'health-education': `That's an important health topic to learn about. This condition affects many people and can have various impacts on daily life. The most common symptoms include [symptoms]. Treatment options typically include [treatments]. Lifestyle changes such as [changes] can also help manage the condition. For more detailed information, I recommend consulting with a healthcare professional or reputable health resources.`,
                    
                    'lifestyle': `Making healthy lifestyle choices can significantly impact your overall well-being. Based on your question, I'd recommend focusing on a balanced diet rich in fruits, vegetables, whole grains, and lean proteins. Regular physical activity, aiming for at least 30 minutes most days of the week, is also important. Additionally, getting adequate sleep (7-9 hours for adults) and managing stress through techniques like meditation or deep breathing can contribute to better health.`,
                    
                    'mental-health': `Taking care of your mental health is just as important as your physical health. It's normal to experience ups and downs, but if you're struggling, there are resources available. Consider talking with a trusted friend or family member, practicing self-care activities you enjoy, and maintaining a regular routine. If your feelings persist or worsen, please consider reaching out to a mental health professional who can provide specialized support.`,
                    
                    'other': `Thank you for your question. While I can provide general health information, it's important to remember that I'm not a substitute for professional medical advice. For personalized guidance, please consult with a healthcare provider who can take into account your complete medical history and current health status. Is there anything else I can help with in a general capacity?`
                };
                
                return responses[task] || responses['other'];
            }
            
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            // ==================== HEALTH DASHBOARD FUNCTIONS ====================
            let metricsChart = null;
            
            // Load and display health dashboard
            async function loadHealthDashboard() {
                const healthDashboard = document.getElementById('healthDashboard');
                const patientForm = document.getElementById('patientForm');
                
                try {
                    const response = await fetch('/patient/health-dashboard', {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to load health dashboard');
                    
                    const data = await response.json();
                    
                    // Display risk scores
                    displayRiskScores(data.risk_score);
                    
                    // Display health metrics chart
                    displayHealthMetrics(data.health_metrics);
                    
                    // Show health dashboard instead of patient form
                    if (patientForm) patientForm.style.display = 'none';
                    healthDashboard.style.display = 'block';
                    
                } catch (err) {
                    console.error('Error loading health dashboard:', err);
                    showNotification('Failed to load health dashboard', 'error');
                }
            }

            // Display risk scores with color coding
            function displayRiskScores(riskData) {
                const riskLevel = document.getElementById('riskLevel');
                const readmissionRiskBar = document.getElementById('readmissionRiskBar');
                const readmissionRiskPct = document.getElementById('readmissionRiskPct');
                const noshowRiskBar = document.getElementById('noshowRiskBar');
                const noshowRiskPct = document.getElementById('noshowRiskPct');
                const complicationRiskBar = document.getElementById('complicationRiskBar');
                const complicationRiskPct = document.getElementById('complicationRiskPct');

                // Update readmission risk
                const readmissionPct = Math.round(riskData.readmission_risk || 0);
                readmissionRiskBar.style.width = readmissionPct + '%';
                readmissionRiskPct.textContent = readmissionPct + '%';
                readmissionRiskBar.className = `progress-bar ${getProgressBarColor(readmissionPct)}`;

                // Update no-show risk
                const noshowPct = Math.round(riskData.no_show_risk || 0);
                noshowRiskBar.style.width = noshowPct + '%';
                noshowRiskPct.textContent = noshowPct + '%';
                noshowRiskBar.className = `progress-bar ${getProgressBarColor(noshowPct)}`;

                // Update complication risk
                const complicationPct = Math.round(riskData.complication_risk || 10);
                complicationRiskBar.style.width = complicationPct + '%';
                complicationRiskPct.textContent = complicationPct + '%';
                complicationRiskBar.className = `progress-bar ${getProgressBarColor(complicationPct)}`;

                // Update overall risk level
                const overallRisk = riskData.risk_level || 'LOW';
                riskLevel.className = `risk-badge ${overallRisk.toLowerCase()}`;
                riskLevel.innerHTML = `<i class="bi bi-${getRiskIcon(overallRisk)} me-1"></i>${overallRisk} RISK`;
            }

            // Get progress bar color based on percentage
            function getProgressBarColor(percentage) {
                if (percentage < 33) return 'bg-success';
                if (percentage < 66) return 'bg-warning';
                return 'bg-danger';
            }

            // Get icon for risk level
            function getRiskIcon(level) {
                const icons = {
                    'low': 'shield-check',
                    'medium': 'exclamation-circle',
                    'high': 'exclamation-triangle'
                };
                return icons[level.toLowerCase()] || 'shield-check';
            }

            // Display health metrics on chart
            function displayHealthMetrics(metrics) {
                const ctx = document.getElementById('metricsChart');
                if (!ctx) return;

                // Group metrics by type
                const metricsByType = {};
                metrics.forEach(metric => {
                    if (!metricsByType[metric.metric_type]) {
                        metricsByType[metric.metric_type] = [];
                    }
                    metricsByType[metric.metric_type].push({
                        date: new Date(metric.metric_date).toLocaleDateString(),
                        value: parseFloat(metric.metric_value)
                    });
                });

                // Get first metric type for initial display
                const firstType = Object.keys(metricsByType)[0];
                renderChart(metricsByType, firstType);

                // Handle metric type selector
                const selector = document.getElementById('metricTypeSelector');
                selector.addEventListener('change', (e) => {
                    const selectedType = e.target.value;
                    renderChart(metricsByType, selectedType);
                });
            }

            // Render chart with selected metric type
            function renderChart(metricsByType, selectedType) {
                const ctx = document.getElementById('metricsChart');
                if (!ctx) return;

                // Destroy existing chart if it exists
                if (metricsChart) {
                    metricsChart.destroy();
                }

                // Prepare data based on selection
                let chartData;
                if (selectedType && metricsByType[selectedType]) {
                    const data = metricsByType[selectedType];
                    chartData = {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: selectedType,
                            data: data.map(d => d.value),
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    };
                } else {
                    // Show all metrics as multiple lines
                    const colors = ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1'];
                    let colorIndex = 0;
                    const datasets = [];

                    Object.keys(metricsByType).forEach(type => {
                        const data = metricsByType[type];
                        datasets.push({
                            label: type,
                            data: data.map(d => d.value),
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: colors[colorIndex % colors.length] + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        });
                        colorIndex++;
                    });

                    chartData = {
                        labels: Array.from(new Set(Object.values(metricsByType).flat().map(d => d.date))).sort(),
                        datasets: datasets
                    };
                }

                // Create chart
                metricsChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Value'
                                }
                            }
                        }
                    }
                });
            }

            // Submit new health metric
            async function submitHealthMetric() {
                const metricType = document.getElementById('newMetricType').value;
                const metricValue = document.getElementById('newMetricValue').value;
                const metricDate = document.getElementById('newMetricDate').value;
                const metricNotes = document.getElementById('newMetricNotes').value;

                if (!metricType || !metricValue || !metricDate) {
                    showNotification('Please fill in all required fields', 'warning');
                    return;
                }

                try {
                    const response = await fetch('/log-health-metric', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}`
                        },
                        body: JSON.stringify({
                            metric_type: metricType,
                            metric_value: parseFloat(metricValue),
                            metric_date: metricDate,
                            notes: metricNotes
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to log metric');
                    }

                    showNotification('Health metric logged successfully!', 'success');
                    
                    // Clear form
                    document.getElementById('newMetricType').value = '';
                    document.getElementById('newMetricValue').value = '';
                    document.getElementById('newMetricDate').value = '';
                    document.getElementById('newMetricNotes').value = '';
                    
                    // Reload dashboard
                    loadHealthDashboard();
                } catch (err) {
                    console.error('Error logging metric:', err);
                    showNotification(err.message || 'Failed to log health metric', 'error');
                }
            }

            // Download health report
            async function downloadHealthReport() {
                try {
                    const response = await fetch('/patient/health-report', {
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    if (!response.ok) throw new Error('Failed to generate report');

                    const data = await response.json();
                    
                    // Create a simple text report and download
                    const reportText = generateReportText(data);
                    const element = document.createElement('a');
                    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(reportText));
                    element.setAttribute('download', `Health_Report_${new Date().toISOString().split('T')[0]}.txt`);
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);

                    showNotification('Health report downloaded successfully!', 'success');
                } catch (err) {
                    console.error('Error downloading report:', err);
                    showNotification('Failed to download health report', 'error');
                }
            }

            // Generate report text
            function generateReportText(reportData) {
                let text = '=== HEALTH REPORT ===\n\n';
                text += `Generated: ${new Date().toLocaleDateString()}\n`;
                text += `Report Period: Last 90 Days\n\n`;
                
                text += '--- METRICS SUMMARY ---\n';
                if (reportData.metrics_summary) {
                    Object.entries(reportData.metrics_summary).forEach(([key, value]) => {
                        text += `${key}: ${value}\n`;
                    });
                }
                
                text += '\n--- SESSIONS SUMMARY ---\n';
                if (reportData.session_summary) {
                    text += `Total Sessions: ${reportData.session_summary.total_sessions || 0}\n`;
                    text += `Average Session Duration: ${reportData.session_summary.avg_duration_minutes || 0} minutes\n`;
                }
                
                text += '\n--- AI INSIGHTS ---\n';
                text += reportData.report_text || 'No insights available at this time.';
                
                return text;
            }

            // ==================== MEDICATIONS & DOCUMENTS ====================
            async function loadMedications() {
                const listEl = document.getElementById('medicationsList');
                if (!listEl) return;
                listEl.innerHTML = '<div class="text-muted">Loading medications...</div>';

                try {
                    const resp = await fetch('/medications', {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load medications');

                    const meds = data.medications || [];
                    if (!meds.length) {
                        listEl.innerHTML = '<div class="text-muted">No medications yet.</div>';
                        return;
                    }

                    listEl.innerHTML = meds.map(m => {
                        const times = Array.isArray(m.times) ? m.times.join(', ') : (m.times || '');
                        return `
                            <div class="border rounded p-3 mb-2">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>${m.medication_name}</strong>
                                        <div class="text-muted small">${m.dosage || ''} ${m.frequency || ''}</div>
                                        <div class="small">Times: ${times}</div>
                                        <div class="small">Active: ${m.active ? 'Yes' : 'No'}</div>
                                    </div>
                                    <div class="text-end">
                                        <button class="btn btn-sm btn-success mb-2" data-med-action="taken" data-med-id="${m.id}">
                                            <i class="bi bi-check2"></i> Mark Taken
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" data-med-action="delete" data-med-id="${m.id}">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (err) {
                    listEl.innerHTML = '<div class="text-danger">Failed to load medications.</div>';
                    showNotification(err.message || 'Failed to load medications', 'error');
                }
            }

            async function addMedication() {
                const name = document.getElementById('medName')?.value.trim();
                const dosage = document.getElementById('medDosage')?.value.trim();
                const frequency = document.getElementById('medFrequency')?.value.trim();
                const timesStr = document.getElementById('medTimes')?.value.trim();
                const startDate = document.getElementById('medStartDate')?.value;
                const endDate = document.getElementById('medEndDate')?.value;
                const notes = document.getElementById('medNotes')?.value.trim();

                if (!name) {
                    showNotification('Medication name is required', 'warning');
                    return;
                }

                const times = timesStr ? timesStr.split(',').map(t => t.trim()).filter(Boolean) : [];

                try {
                    const resp = await fetch('/medications', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}`
                        },
                        body: JSON.stringify({
                            medication_name: name,
                            dosage,
                            frequency,
                            times,
                            start_date: startDate,
                            end_date: endDate,
                            notes
                        })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to save medication');

                    showNotification('Medication saved', 'success');
                    document.getElementById('medName').value = '';
                    document.getElementById('medDosage').value = '';
                    document.getElementById('medFrequency').value = '';
                    document.getElementById('medTimes').value = '';
                    document.getElementById('medStartDate').value = '';
                    document.getElementById('medEndDate').value = '';
                    document.getElementById('medNotes').value = '';
                    loadMedications();
                } catch (err) {
                    showNotification(err.message || 'Failed to save medication', 'error');
                }
            }

            async function logMedicationIntake(scheduleId) {
                try {
                    const resp = await fetch(`/medications/${scheduleId}/intake`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}`
                        },
                        body: JSON.stringify({ status: 'taken' })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to log intake');
                    showNotification('Marked as taken', 'success');
                    loadAdherence();
                } catch (err) {
                    showNotification(err.message || 'Failed to log intake', 'error');
                }
            }

            async function deleteMedication(scheduleId) {
                try {
                    const resp = await fetch(`/medications/${scheduleId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to delete');
                    showNotification('Medication deleted', 'success');
                    loadMedications();
                } catch (err) {
                    showNotification(err.message || 'Failed to delete medication', 'error');
                }
            }

            async function loadAdherence() {
                try {
                    const resp = await fetch('/medications/adherence', {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load adherence');

                    const pct = data.adherence_percent || 0;
                    document.getElementById('adherencePercent').textContent = `${pct}%`;
                    document.getElementById('adherenceBar').style.width = `${pct}%`;
                    document.getElementById('adherenceTaken').textContent = data.counts?.taken || 0;
                    document.getElementById('adherenceMissed').textContent = data.counts?.missed || 0;
                    document.getElementById('adherenceSkipped').textContent = data.counts?.skipped || 0;
                    document.getElementById('adherencePending').textContent = data.counts?.pending || 0;
                } catch (err) {
                    showNotification(err.message || 'Failed to load adherence', 'error');
                }
            }

            async function loadDocuments() {
                const listEl = document.getElementById('documentsList');
                if (!listEl) return;
                listEl.innerHTML = '<div class="text-muted">Loading documents...</div>';

                try {
                    const resp = await fetch('/documents', {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load documents');

                    const docs = data.documents || [];
                    if (!docs.length) {
                        listEl.innerHTML = '<div class="text-muted">No documents uploaded.</div>';
                        return;
                    }

                    listEl.innerHTML = docs.map(d => `
                        <div class="border rounded p-3 mb-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${d.file_name}</strong>
                                    <div class="text-muted small">Type: ${d.document_type}</div>
                                    <div class="small">Processed: ${d.processed ? 'Yes' : 'No'}</div>
                                </div>
                                <div>
                                    ${d.processed ? '' : `
                                        <button class="btn btn-sm btn-outline-primary" data-doc-action="process" data-doc-id="${d.id}">
                                            <i class="bi bi-magic"></i> OCR
                                        </button>
                                    `}
                                </div>
                            </div>
                            ${d.extracted_text ? `<div class="small text-muted mt-2">${escapeHtml(d.extracted_text).slice(0, 200)}...</div>` : ''}
                        </div>
                    `).join('');
                } catch (err) {
                    listEl.innerHTML = '<div class="text-danger">Failed to load documents.</div>';
                    showNotification(err.message || 'Failed to load documents', 'error');
                }
            }

            async function uploadDocument() {
                const fileInput = document.getElementById('docFile');
                const docType = document.getElementById('docType')?.value || 'report';
                if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                    showNotification('Please choose a file to upload', 'warning');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('document_type', docType);

                try {
                    const resp = await fetch('/documents/upload', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${getToken()}` },
                        body: formData
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to upload document');
                    showNotification('Document uploaded', 'success');
                    fileInput.value = '';
                    loadDocuments();
                } catch (err) {
                    showNotification(err.message || 'Failed to upload document', 'error');
                }
            }

            async function processDocument(docId) {
                try {
                    const resp = await fetch(`/documents/${docId}/process`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to process document');
                    showNotification('Document processed', 'success');
                    loadDocuments();
                } catch (err) {
                    showNotification(err.message || 'Failed to process document', 'error');
                }
            }

            async function loadNotificationPreferences() {
                try {
                    const resp = await fetch('/notifications/preferences', {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load preferences');

                    document.getElementById('prefMedicationReminders').checked = !!data.medication_reminders;
                    document.getElementById('prefHealthAlerts').checked = !!data.health_alerts;
                    document.getElementById('prefWellnessTips').checked = !!data.wellness_tips;
                    document.getElementById('prefEmailNotifications').checked = !!data.email_notifications;
                    document.getElementById('prefSmsNotifications').checked = !!data.sms_notifications;
                    document.getElementById('prefAppointmentReminders').checked = !!data.appointment_reminders;
                    const tzSelect = document.getElementById('prefTimezone');
                    if (tzSelect) {
                        const browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
                        tzSelect.value = data.timezone || browserTz;
                    }
                } catch (err) {
                    showNotification(err.message || 'Failed to load preferences', 'error');
                }
            }

            async function saveNotificationPreferences() {
                try {
                    const payload = {
                        medication_reminders: document.getElementById('prefMedicationReminders').checked,
                        health_alerts: document.getElementById('prefHealthAlerts').checked,
                        wellness_tips: document.getElementById('prefWellnessTips').checked,
                        email_notifications: document.getElementById('prefEmailNotifications').checked,
                        sms_notifications: document.getElementById('prefSmsNotifications').checked,
                        appointment_reminders: document.getElementById('prefAppointmentReminders').checked,
                        timezone: document.getElementById('prefTimezone')?.value || 'UTC'
                    };
                    const resp = await fetch('/notifications/preferences', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}`
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to save preferences');
                    showNotification('Preferences saved', 'success');
                } catch (err) {
                    showNotification(err.message || 'Failed to save preferences', 'error');
                }
            }

            async function sendTestReminder() {
                try {
                    const resp = await fetch('/medications/remind', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}`
                        },
                        body: JSON.stringify({
                            medication_name: 'Test Medication',
                            dosage: '1 tablet',
                            frequency: 'once',
                            time: new Date().toLocaleTimeString()
                        })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to send reminder');
                    showNotification('Test reminder sent', 'success');
                } catch (err) {
                    showNotification(err.message || 'Failed to send reminder', 'error');
                }
            }

            async function verifyDeliveryChannels() {
                try {
                    const profileResp = await fetch('/profile', {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const profile = await profileResp.json();
                    if (!profileResp.ok) throw new Error(profile.error || 'Failed to load profile');

                    const contact = (profile.contact || '').trim();
                    let email = '';
                    let phone = '';
                    if (contact.includes('@')) email = contact;
                    else if (contact) phone = contact;

                    const resp = await fetch('/test/notifications', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getToken()}`
                        },
                        body: JSON.stringify({ email, phone })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Verification failed');

                    const status = [];
                    if (email) status.push(`Email: ${data.email_sent ? 'sent' : 'not sent'}`);
                    if (phone) status.push(`SMS: ${data.sms_sent ? 'sent' : 'not sent'}`);
                    showNotification(status.join(' | ') || 'No contact info available', 'info');
                } catch (err) {
                    showNotification(err.message || 'Verification failed', 'error');
                }
            }

            // Show notification
            function showNotification(message, type = 'info') {
                const alertClass = {
                    'success': 'alert-success',
                    'error': 'alert-danger',
                    'warning': 'alert-warning',
                    'info': 'alert-info'
                }[type] || 'alert-info';

                const notification = document.createElement('div');
                notification.className = `alert ${alertClass} alert-dismissible fade show notification`;
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            // Nearby Hospitals Functionality
            let hospitalMap = null;
            let hospitalMarkers = [];
            
            async function findNearbyHospitals() {
                const radiusInput = document.getElementById('hospitalSearchRadius');
                const radius = parseInt(radiusInput?.value || 10);
                
                if (!navigator.geolocation) {
                    showNotification('Geolocation is not supported by your browser', 'error');
                    return;
                }
                
                try {
                    // Show loading
                    const mapContainer = document.getElementById('hospitalMapContainer');
                    const oldContent = mapContainer.innerHTML;
                    mapContainer.innerHTML = '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Getting your location...</p></div>';
                    
                    // Get user location
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    });
                    
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    
                    // Fetch nearby hospitals from backend
                    const response = await fetch('/hospitals/nearby', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            latitude: userLat,
                            longitude: userLng,
                            radius: radius
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to fetch hospitals');
                    }
                    
                    // Initialize map
                    mapContainer.innerHTML = '<div id="hospitalMap" style="width: 100%; height: 100%;"></div>';
                    const mapElement = document.getElementById('hospitalMap');
                    
                    if (typeof google === 'undefined' || !google.maps) {
                        mapElement.innerHTML = '<div class="alert alert-warning m-3">Google Maps is not available. Please check your internet connection.</div>';
                        displayHospitalsList(data.hospitals, userLat, userLng);
                        return;
                    }
                    
                    // Create map centered on user location
                    hospitalMap = new google.maps.Map(mapElement, {
                        center: { lat: userLat, lng: userLng },
                        zoom: 12,
                        styles: [{ featureType: 'poi.medical', stylers: [{ visibility: 'on' }] }]
                    });
                    
                    // Clear old markers
                    hospitalMarkers.forEach(marker => marker.setMap(null));
                    hospitalMarkers = [];
                    
                    // Add user location marker
                    const userMarker = new google.maps.Marker({
                        position: { lat: userLat, lng: userLng },
                        map: hospitalMap,
                        title: 'Your Location',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#4285F4',
                            fillOpacity: 1,
                            strokeColor: '#fff',
                            strokeWeight: 2
                        }
                    });
                    hospitalMarkers.push(userMarker);
                    
                    // Add hospital markers
                    data.hospitals.forEach((hospital, index) => {
                        if (hospital.latitude && hospital.longitude) {
                            const marker = new google.maps.Marker({
                                position: { lat: hospital.latitude, lng: hospital.longitude },
                                map: hospitalMap,
                                title: hospital.name,
                                label: String(index + 1),
                                icon: {
                                    url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                                }
                            });
                            
                            const infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div style="padding: 8px;">
                                        <h6 class="mb-2">${hospital.name}</h6>
                                        <p class="mb-1 small"><i class="bi bi-geo-alt"></i> ${hospital.location || 'Location not specified'}</p>
                                        <p class="mb-1 small"><i class="bi bi-telephone"></i> ${hospital.contact || 'N/A'}</p>
                                        <p class="mb-0 small"><strong>Distance:</strong> ${hospital.distance} km</p>
                                    </div>
                                `
                            });
                            
                            marker.addListener('click', () => {
                                infoWindow.open(hospitalMap, marker);
                            });
                            
                            hospitalMarkers.push(marker);
                        }
                    });
                    
                    // Display hospitals list
                    displayHospitalsList(data.hospitals, userLat, userLng);
                    
                    showNotification(`Found ${data.count} hospitals within ${radius} km`, 'success');
                    
                } catch (err) {
                    console.error('Error finding hospitals:', err);
                    showNotification('Failed to get location or find hospitals: ' + err.message, 'error');
                    document.getElementById('hospitalMapContainer').innerHTML = '<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle"></i> ' + err.message + '</div>';
                }
            }
            
            function displayHospitalsList(hospitals, userLat, userLng) {
                const listContainer = document.getElementById('hospitalsList');
                
                if (!hospitals || hospitals.length === 0) {
                    listContainer.innerHTML = '<div class="alert alert-info">No hospitals found in this area. Try increasing the search radius.</div>';
                    return;
                }
                
                let html = '<div class="list-group">';
                hospitals.forEach((hospital, index) => {
                    const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${hospital.latitude},${hospital.longitude}`;
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1"><span class="badge bg-danger me-2">${index + 1}</span>${hospital.name}</h6>
                                    <p class="mb-1 small text-muted"><i class="bi bi-geo-alt"></i> ${hospital.location || 'Location not specified'}</p>
                                    <p class="mb-1 small"><i class="bi bi-telephone"></i> ${hospital.contact || 'N/A'}</p>
                                    ${hospital.distance ? `<p class="mb-0 small"><strong>Distance:</strong> ${hospital.distance} km away</p>` : ''}
                                </div>
                                <div>
                                    <a href="${directionsUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-navigation"></i> Directions
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listContainer.innerHTML = html;
            }
            
            // Initialize nearby hospitals listeners
            document.getElementById('findHospitalsBtn')?.addEventListener('click', findNearbyHospitals);
            document.getElementById('refreshHospitalsBtn')?.addEventListener('click', findNearbyHospitals);
            
            // Initialize health dashboard event listeners
            function initHealthDashboardListeners() {
                const submitMetricBtn = document.getElementById('submitMetricBtn');
                const downloadReportBtn = document.getElementById('downloadReportBtn');
                const addMedicationBtn = document.getElementById('addMedicationBtn');
                const refreshMedicationsBtn = document.getElementById('refreshMedicationsBtn');
                const refreshAdherenceBtn = document.getElementById('refreshAdherenceBtn');
                const uploadDocBtn = document.getElementById('uploadDocBtn');
                const refreshDocsBtn = document.getElementById('refreshDocsBtn');
                const saveNotificationPrefsBtn = document.getElementById('saveNotificationPrefsBtn');
                const verifyChannelsBtn = document.getElementById('verifyChannelsBtn');
                const sendTestReminderBtn = document.getElementById('sendTestReminderBtn');

                if (submitMetricBtn) {
                    submitMetricBtn.addEventListener('click', submitHealthMetric);
                }

                if (downloadReportBtn) {
                    downloadReportBtn.addEventListener('click', downloadHealthReport);
                }

                if (addMedicationBtn) {
                    addMedicationBtn.addEventListener('click', addMedication);
                }

                if (refreshMedicationsBtn) {
                    refreshMedicationsBtn.addEventListener('click', loadMedications);
                }

                if (refreshAdherenceBtn) {
                    refreshAdherenceBtn.addEventListener('click', loadAdherence);
                }

                if (uploadDocBtn) {
                    uploadDocBtn.addEventListener('click', uploadDocument);
                }

                if (refreshDocsBtn) {
                    refreshDocsBtn.addEventListener('click', loadDocuments);
                }

                if (saveNotificationPrefsBtn) {
                    saveNotificationPrefsBtn.addEventListener('click', saveNotificationPreferences);
                }

                if (verifyChannelsBtn) {
                    verifyChannelsBtn.addEventListener('click', verifyDeliveryChannels);
                }

                if (sendTestReminderBtn) {
                    sendTestReminderBtn.addEventListener('click', sendTestReminder);
                }

                document.addEventListener('click', (e) => {
                    const target = e.target.closest('[data-med-action], [data-doc-action]');
                    if (!target) return;
                    const medAction = target.getAttribute('data-med-action');
                    const docAction = target.getAttribute('data-doc-action');
                    if (medAction) {
                        const id = target.getAttribute('data-med-id');
                        if (medAction === 'taken') logMedicationIntake(id);
                        if (medAction === 'delete') deleteMedication(id);
                    }
                    if (docAction) {
                        const id = target.getAttribute('data-doc-id');
                        if (docAction === 'process') processDocument(id);
                    }
                });
            }

            // ==================== PHASE 3: DIRECT MESSAGES & NOTIFICATIONS ====================
            let dmPollingTimer = null;
            let currentDmDoctorId = null;

            async function initDirectMessaging() {
                await loadDmDoctors();
                const dmSendBtn = document.getElementById('dmSendBtn');
                const dmInput = document.getElementById('dmInput');
                const markAllBtn = document.getElementById('markAllNotificationsReadBtn');

                if (dmSendBtn) dmSendBtn.addEventListener('click', sendDirectMessage);
                if (dmInput) {
                    dmInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') sendDirectMessage();
                    });
                }
                if (markAllBtn) markAllBtn.addEventListener('click', markAllNotificationsRead);

                if (!dmPollingTimer) {
                    dmPollingTimer = setInterval(() => {
                        if (currentDmDoctorId) loadDirectMessages();
                        loadNotifications();
                    }, 5000);
                }

                loadNotifications();
            }

            async function loadDmDoctors() {
                const token = getToken();
                if (!token) return;
                const select = document.getElementById('dmDoctorSelect');
                if (!select) return;

                try {
                    const resp = await fetch('/doctors', { headers: { 'Authorization': 'Bearer ' + token } });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load doctors');

                    let threads = [];
                    try {
                        const threadResp = await fetch('/messages/threads', { headers: { 'Authorization': 'Bearer ' + token } });
                        const threadData = await threadResp.json();
                        if (threadResp.ok) threads = threadData.threads || [];
                    } catch (e) { /* ignore thread fetch */ }

                    const doctors = data.doctors || [];
                    const options = new Map();
                    doctors.forEach(d => {
                        options.set(d.id, {
                            id: d.id,
                            label: d.full_name || d.username || 'Doctor'
                        });
                    });
                    threads.forEach(t => {
                        if (!t.other_user_id) return;
                        if (!options.has(t.other_user_id)) {
                            options.set(t.other_user_id, {
                                id: t.other_user_id,
                                label: t.other_user_name || 'User'
                            });
                        }
                    });

                    select.innerHTML = '';
                    Array.from(options.values()).forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.id;
                        opt.textContent = item.label;
                        select.appendChild(opt);
                    });

                    currentDmDoctorId = select.value ? Number(select.value) : null;
                    select.addEventListener('change', () => {
                        currentDmDoctorId = select.value ? Number(select.value) : null;
                        loadDirectMessages();
                    });

                    if (currentDmDoctorId) loadDirectMessages();
                } catch (e) {
                    showNotification('Failed to load doctors', 'error');
                }
            }

            async function loadDirectMessages() {
                const token = getToken();
                if (!token || !currentDmDoctorId) return;
                const dmMessages = document.getElementById('dmMessages');
                if (!dmMessages) return;

                try {
                    const resp = await fetch(`/messages?other_user_id=${currentDmDoctorId}`, {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load messages');

                    dmMessages.innerHTML = '';
                    (data.messages || []).forEach(m => {
                        const bubble = document.createElement('div');
                        bubble.className = 'dm-message' + (m.sender_id === (getTokenUserId() || -1) ? ' me' : '');
                        bubble.innerHTML = `<div>${escapeHtml(m.message_text || '')}</div><div class="dm-meta">${new Date(m.created_at).toLocaleString()}</div>`;
                        dmMessages.appendChild(bubble);
                    });
                    dmMessages.scrollTop = dmMessages.scrollHeight;

                    await fetch('/messages/mark-read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ other_user_id: currentDmDoctorId })
                    });
                } catch (e) {
                    showNotification('Failed to load messages', 'error');
                }
            }

            async function sendDirectMessage() {
                const token = getToken();
                const input = document.getElementById('dmInput');
                if (!token || !currentDmDoctorId || !input) return;
                const text = input.value.trim();
                if (!text) return;

                try {
                    const resp = await fetch('/messages/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ recipient_id: currentDmDoctorId, message_text: text })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to send message');
                    input.value = '';
                    loadDirectMessages();
                } catch (e) {
                    showNotification('Failed to send message', 'error');
                }
            }

            async function loadNotifications() {
                const token = getToken();
                if (!token) return;
                const container = document.getElementById('patientNotifications');
                if (!container) return;

                try {
                    const resp = await fetch('/notifications?unread=1', { headers: { 'Authorization': 'Bearer ' + token } });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load notifications');

                    const items = data.notifications || [];
                    if (!items.length) {
                        container.innerHTML = '<div class="text-muted">No notifications yet.</div>';
                        return;
                    }

                    container.innerHTML = items.map(n => `
                        <div class="border-bottom pb-2 mb-2">
                            <div class="fw-semibold">${escapeHtml(n.title || 'Notification')}</div>
                            <div class="small text-muted">${escapeHtml(n.body || '')}</div>
                            <div class="small text-muted">${new Date(n.created_at).toLocaleString()}</div>
                        </div>
                    `).join('');
                } catch (e) {
                    container.innerHTML = '<div class="text-danger">Failed to load notifications.</div>';
                }
            }

            async function markAllNotificationsRead() {
                const token = getToken();
                if (!token) return;
                try {
                    await fetch('/notifications/mark-read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({})
                    });
                    loadNotifications();
                } catch (e) {
                    showNotification('Failed to mark notifications read', 'error');
                }
            }

            function getTokenUserId() {
                const token = getToken();
                if (!token) return null;
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.sub || null;
                } catch (e) {
                    return null;
                }
            }

            // ==================== PHASE 3: COMMUNITY FORUM ====================
            let currentForumPostId = null;

            function initForum() {
                const refreshBtn = document.getElementById('forumRefreshBtn');
                const postBtn = document.getElementById('forumPostBtn');
                const replyBtn = document.getElementById('forumReplyBtn');

                refreshBtn?.addEventListener('click', loadForumPosts);
                postBtn?.addEventListener('click', createForumPost);
                replyBtn?.addEventListener('click', createForumReply);

                loadForumPosts();
            }

            async function loadForumPosts() {
                const token = getToken();
                if (!token) return;
                const filter = document.getElementById('forumConditionFilter');
                const condition = filter ? filter.value.trim() : '';
                const postsEl = document.getElementById('forumPosts');
                if (!postsEl) return;

                try {
                    const url = condition ? `/forum/posts?condition_tag=${encodeURIComponent(condition)}` : '/forum/posts';
                    const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load posts');

                    const posts = data.posts || [];
                    if (!posts.length) {
                        postsEl.innerHTML = '<div class="text-muted">No posts yet.</div>';
                        return;
                    }

                    postsEl.innerHTML = posts.map(p => `
                        <div class="border-bottom pb-2 mb-2">
                            <div class="fw-semibold">${escapeHtml(p.title || '')}</div>
                            <div class="small text-muted">${escapeHtml(p.condition_tag || 'General')} â€¢ ${new Date(p.created_at).toLocaleDateString()} â€¢ ${p.reply_count || 0} replies</div>
                            <div class="small mt-1">${escapeHtml((p.body || '').slice(0, 120))}${(p.body || '').length > 120 ? '...' : ''}</div>
                            <button class="btn btn-sm btn-outline-primary mt-2 forum-view-btn" data-post-id="${p.id}">View</button>
                        </div>
                    `).join('');

                    postsEl.querySelectorAll('.forum-view-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const postId = Number(btn.getAttribute('data-post-id'));
                            if (postId) loadForumPostDetail(postId);
                        });
                    });
                } catch (e) {
                    postsEl.innerHTML = '<div class="text-danger">Failed to load posts.</div>';
                }
            }

            async function createForumPost() {
                const token = getToken();
                if (!token) return;
                const title = document.getElementById('forumPostTitle')?.value.trim();
                const body = document.getElementById('forumPostBody')?.value.trim();
                const condition = document.getElementById('forumPostCondition')?.value.trim();

                if (!title || !body) {
                    showNotification('Title and body are required', 'warning');
                    return;
                }

                try {
                    const resp = await fetch('/forum/posts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ title, body, condition_tag: condition })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to create post');

                    document.getElementById('forumPostTitle').value = '';
                    document.getElementById('forumPostBody').value = '';
                    document.getElementById('forumPostCondition').value = '';
                    showNotification('Post created successfully', 'success');
                    loadForumPosts();
                } catch (e) {
                    showNotification('Failed to create post', 'error');
                }
            }

            async function loadForumPostDetail(postId) {
                const token = getToken();
                if (!token) return;
                const detailEl = document.getElementById('forumPostDetail');
                const titleEl = document.getElementById('forumDetailTitle');
                const bodyEl = document.getElementById('forumDetailBody');
                const repliesEl = document.getElementById('forumReplies');

                if (!detailEl || !titleEl || !bodyEl || !repliesEl) return;

                try {
                    const resp = await fetch(`/forum/posts/${postId}`, { headers: { 'Authorization': 'Bearer ' + token } });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to load post');

                    currentForumPostId = postId;
                    detailEl.style.display = 'block';
                    titleEl.textContent = data.post.title || '';
                    bodyEl.textContent = data.post.body || '';
                    repliesEl.innerHTML = (data.replies || []).map(r => `
                        <div class="border-bottom pb-2 mb-2">
                            <div class="small text-muted">${escapeHtml(r.full_name || r.username || 'User')} â€¢ ${new Date(r.created_at).toLocaleString()}</div>
                            <div>${escapeHtml(r.body || '')}</div>
                        </div>
                    `).join('') || '<div class="text-muted">No replies yet.</div>';
                } catch (e) {
                    showNotification('Failed to load post', 'error');
                }
            }

            async function createForumReply() {
                const token = getToken();
                if (!token || !currentForumPostId) return;
                const body = document.getElementById('forumReplyBody')?.value.trim();
                if (!body) return;

                try {
                    const resp = await fetch(`/forum/posts/${currentForumPostId}/replies`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                        body: JSON.stringify({ body })
                    });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Failed to add reply');

                    document.getElementById('forumReplyBody').value = '';
                    loadForumPostDetail(currentForumPostId);
                } catch (e) {
                    showNotification('Failed to add reply', 'error');
                }
            }
        });
    </script>
</body>
</html>
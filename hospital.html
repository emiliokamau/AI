<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hospital Management - Medical AI Assistant</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <img src="/static/logo.svg" alt="Logo" style="width: 40px; height: 40px;">
                <h2 class="mb-0">Hospital Management</h2>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="window.location.href='/doctor'">Back to Doctor</button>
                <button id="logoutBtn" class="btn btn-sm btn-outline-secondary">Sign Out</button>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <h5>Add Hospital</h5>
            <div class="row g-2">
                <div class="col-md-6">
                    <label class="form-label">Hospital Name</label>
                    <input id="hospitalName" class="form-control" placeholder="Hospital name" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Phone</label>
                    <input id="hospitalPhone" class="form-control" placeholder="Phone" />
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input id="hospitalEmail" class="form-control" placeholder="Email" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Website</label>
                    <input id="hospitalWebsite" class="form-control" placeholder="Website" />
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-6">
                    <label class="form-label">Address</label>
                    <input id="hospitalAddress" class="form-control" placeholder="Address" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">City</label>
                    <input id="hospitalCity" class="form-control" placeholder="City" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Country</label>
                    <input id="hospitalCountry" class="form-control" placeholder="Country" />
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-12">
                    <label class="form-label">Map Query (optional)</label>
                    <input id="hospitalMapQuery" class="form-control" placeholder="e.g., Hospital Name, City" />
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-12">
                    <label class="form-label">Description</label>
                    <textarea id="hospitalDescription" class="form-control" rows="3" placeholder="Hospital details"></textarea>
                </div>
            </div>
            <div class="mt-2 d-flex gap-2">
                <button id="saveHospitalBtn" class="btn btn-primary">Save Hospital</button>
                <button id="refreshHospitalsBtn" class="btn btn-outline-secondary">Refresh</button>
            </div>
            <div id="hospitalResult" class="mt-2"></div>
        </div>

        <div class="card p-3">
            <h5>Hospitals</h5>
            <div id="hospitalList" class="mb-3">
                <p class="text-muted">No hospitals loaded.</p>
            </div>
            <div class="ratio ratio-16x9">
                <iframe id="hospitalMap" src="" style="border:0" allowfullscreen loading="lazy"></iframe>
            </div>
        </div>
    </div>

    <script>
        function getToken(){
            return sessionStorage.getItem('jwt_token');
        }

        async function requireAuth(){
            const token = getToken();
            if (!token) { window.location.href = '/auth'; return false; }
            return true;
        }

        async function loadHospitals(){
            const list = document.getElementById('hospitalList');
            try{
                const resp = await fetch('/hospitals');
                const j = await resp.json();
                const hospitals = j.hospitals || [];
                if (!hospitals.length) {
                    list.innerHTML = '<p class="text-muted">No hospitals found.</p>';
                    return;
                }
                list.innerHTML = hospitals.map(h => `
                    <div class="card mb-2" data-map="${(h.map_query || h.address || h.name || '').replace(/"/g,'')}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${h.name}</strong>
                                    <div class="text-muted small">${h.address || ''} ${h.city || ''} ${h.country || ''}</div>
                                    <div class="small">${h.phone || ''} ${h.email || ''}</div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="showOnMap('${(h.map_query || h.address || h.name || '').replace(/"/g,'')}')">Map</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }catch(e){
                list.innerHTML = '<div class="text-danger">Failed to load hospitals</div>';
            }
        }

        function showOnMap(query){
            const url = `https://www.google.com/maps?q=${encodeURIComponent(query)}&output=embed`;
            document.getElementById('hospitalMap').src = url;
        }

        async function saveHospital(){
            const token = getToken();
            if (!token) return;
            const resultEl = document.getElementById('hospitalResult');
            resultEl.textContent = '';
            const body = {
                name: document.getElementById('hospitalName').value.trim(),
                phone: document.getElementById('hospitalPhone').value.trim(),
                email: document.getElementById('hospitalEmail').value.trim(),
                website: document.getElementById('hospitalWebsite').value.trim(),
                address: document.getElementById('hospitalAddress').value.trim(),
                city: document.getElementById('hospitalCity').value.trim(),
                country: document.getElementById('hospitalCountry').value.trim(),
                map_query: document.getElementById('hospitalMapQuery').value.trim(),
                description: document.getElementById('hospitalDescription').value.trim()
            };
            try{
                const resp = await fetch('/hospitals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(body)
                });
                const j = await resp.json();
                if (!resp.ok) { resultEl.textContent = 'Error: ' + (j.error || resp.statusText); return; }
                resultEl.textContent = 'Hospital saved.';
                await loadHospitals();
                if (body.map_query || body.address || body.name) showOnMap(body.map_query || body.address || body.name);
            }catch(e){
                resultEl.textContent = 'Network error';
            }
        }

        document.getElementById('saveHospitalBtn').addEventListener('click', saveHospital);
        document.getElementById('refreshHospitalsBtn').addEventListener('click', loadHospitals);
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.removeItem('jwt_token');
            sessionStorage.removeItem('user_role');
            window.location.href = '/auth';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const ok = await requireAuth();
            if (!ok) return;
            await loadHospitals();
        });
    </script>
</body>
</html>
